<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Odonto – Orçamentos</title>

  <!-- CSS base -->
  <link rel="stylesheet" href="../css/bootstrap.css" />
  <link rel="stylesheet" href="css/crm.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Sidebar helper -->
  <script src="js/sidebar.js"></script>

  <style>
    /* Esconde a bottom-bar no desktop, mantém no mobile */
    @media (min-width: 992px){
      .bb-dribbble{ display:none !important; }
    }
    .alert-soft{background:#f8fafc;border:1px solid var(--ring);}
    #tbl-mats input{min-width:90px;}
    .crm-hero .crm-actions{ margin-left:auto; display:flex; gap:.5rem; flex-wrap:wrap; }
  </style>
</head>
<body data-page="orcamentos">

<div class="crm-app">
  <!-- Sidebar -->
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <nav class="crm-nav">
      <a href="inicio.html"        data-nav="inicio"><i class="fa-solid fa-grid-2"></i> Início</a>
      <a href="agenda.html"        data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html"     data-nav="pacientes"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html"    data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html"     data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <!-- overlay (mobile) -->
  <div class="crm-overlay" id="crm-overlay"></div>

  <main class="crm-main">
    <!-- Botão hambúrguer (mobile) -->
    <button class="crm-burger" id="btn-sidebar" aria-label="Abrir menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <!-- HERO -->
    <section class="crm-hero">
      <h1 class="text-center mb-1">Orçamentos</h1>
      <div class="crm-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input placeholder="Paciente, procedimento, status..." />
        <button class="btn btn-sm btn-outline-secondary btn-pill">Buscar</button>

        <div class="crm-actions ml-auto">
          <button id="btn-cost-open" class="btn btn-sm btn-outline-secondary btn-pill">
            <i class="fa-solid fa-calculator mr-1"></i> Calcular custo
          </button>
          <button id="btn-new-quote" class="btn btn-sm btn-primary btn-pill">
            <i class="fa-regular fa-clipboard mr-1"></i> Novo orçamento
          </button>
        </div>
      </div>
    </section>

    <!-- CONTEÚDO -->
    <section class="crm-content">
      <div class="crm-card">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>#</th><th>Paciente</th><th>Procedimento</th><th>Valor</th><th>Status</th><th>Validade</th><th></th>
            </tr>
          </thead>
          <tbody id="tbl-orcamentos">
            <tr>
              <td>00123</td><td>Felipe Lima</td><td>Clareamento</td><td>R$ 1.200,00</td>
              <td><span class="badge-soft bg-soft-amber">Enviado</span></td><td>30/08/2025</td>
              <td><a class="btn btn-sm btn-outline-secondary btn-pill">Ver</a></td>
            </tr>
            <tr>
              <td>00124</td><td>Bruna</td><td>Endodontia</td><td>R$ 2.900,00</td>
              <td><span class="badge-soft bg-soft-green">Aprovado</span></td><td>—</td>
              <td><a class="btn btn-sm btn-outline-secondary btn-pill">Ver</a></td>
            </tr>
            <tr>
              <td>00125</td><td>Amanda</td><td>Profilaxia + Consulta</td><td>R$ 300,00</td>
              <td><span class="badge-soft">Rascunho</span></td><td>—</td>
              <td><a class="btn btn-sm btn-outline-secondary btn-pill">Editar</a></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- ================= MODAL: Cálculo de Custo ================= -->
<div class="modal fade" id="md-costing" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <form class="modal-content" id="cost-form">
      <div class="modal-header" style="background:linear-gradient(180deg,#e0f2fe, #f5f3ff); border-bottom:1px solid var(--ring);">
        <div>
          <div class="muted" style="font-size:12px;">Cálculo de custo</div>
          <h5 class="mb-0" id="cst-title">Restauração</h5>
        </div>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <!-- COL ESQ: parâmetros e materiais -->
          <div class="col-lg-7">
            <div class="crm-card mb-3">
              <div class="crm-head-row">
                <h6 class="mb-0">Parâmetros</h6>
                <div class="muted" id="cst-proc-code"></div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-4">
                  <label>Tempo clínico (min)</label>
                  <input type="number" min="0" step="5" class="form-control" id="cst-duration" value="60">
                </div>
                <div class="form-group col-md-4">
                  <label>Custo/hora clínica (R$)</label>
                  <input type="number" min="0" step="1" class="form-control" id="cst-hourly" value="200">
                  <small class="text-muted">Inclui salário, encargos e overhead.</small>
                </div>
                <div class="form-group col-md-4">
                  <label>Preço cobrado (R$)</label>
                  <input type="number" min="0" step="1" class="form-control" id="cst-price" value="0">
                  <small class="text-muted">Se vazio, usaremos só o preço sugerido.</small>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-4">
                  <label>Impostos aprox. (% receita)</label>
                  <input type="number" min="0" max="30" step="0.1" class="form-control" id="cst-tax" value="6">
                  <small class="text-muted">Simples/ISS etc. Ajuste conforme seu regime.</small>
                </div>
                <div class="form-group col-md-4">
                  <label>Pagamento</label>
                  <select id="cst-pay" class="form-control">
                    <option value="pix">PIX</option>
                    <option value="debit">Débito</option>
                    <option value="credit_1x">Crédito 1x</option>
                    <option value="credit_2_6x">Crédito 2–6x</option>
                  </select>
                  <small class="text-muted" id="cst-fee-label">Taxa: —</small>
                </div>
                <div class="form-group col-md-4">
                  <label>Margem alvo (%)</label>
                  <input type="number" min="0" max="90" step="1" class="form-control" id="cst-target" value="40">
                </div>
              </div>
            </div>

            <div class="crm-card">
              <div class="crm-head-row">
                <h6 class="mb-0">Materiais</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary btn-pill" id="btn-add-mat">Adicionar</button>
              </div>

              <div class="table-responsive">
                <table class="table table-sm mb-0" id="tbl-mats">
                  <thead>
                    <tr>
                      <th style="min-width:180px;">Material</th>
                      <th class="text-right">Qtd/uso</th>
                      <th>Un</th>
                      <th class="text-right">Custo unit. (R$)</th>
                      <th class="text-right">Desperdício %</th>
                      <th class="text-right">Subtotal (R$)</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <small class="text-muted d-block mt-2">Dica: cadastre kits (ex.: “Kit esterilização”) como material com custo unitário.</small>
            </div>
          </div>

          <!-- COL DIR: resumo -->
          <div class="col-lg-5">
            <div class="crm-card">
              <h6 class="mb-3">Resumo do custo</h6>
              <ul class="list-unstyled mb-2" id="cst-breakdown"></ul>
              <div class="border-top pt-2 d-flex justify-content-between">
                <strong>Custo total</strong>
                <strong id="cst-total">R$ 0,00</strong>
              </div>
            </div>

            <div class="crm-card mt-3">
              <h6 class="mb-2">Preço & Margem</h6>
              <div class="d-flex justify-content-between">
                <div>Preço atual</div><div id="cst-price-lbl">R$ 0,00</div>
              </div>
              <div class="d-flex justify-content-between">
                <div>Lucro</div><div id="cst-profit">R$ 0,00</div>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <div>Margem</div><div id="cst-margin">0%</div>
              </div>
              <div class="alert alert-soft" role="alert" id="cst-suggest">
                Preço sugerido (margem <span id="cst-target-lbl">40</span>%): <strong id="cst-price-sugg">R$ 0,00</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-pill" type="button" data-dismiss="modal">Fechar</button>
        <button class="btn btn-primary btn-pill" type="submit">Usar no orçamento</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= MODAL: Novo Orçamento ================= -->
<div class="modal fade" id="md-new-quote" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form class="modal-content" id="quote-form" novalidate>
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-regular fa-clipboard mr-2"></i>Novo orçamento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>Paciente</label>
            <input id="q-paciente" class="form-control" required>
            <div class="invalid-feedback">Informe o paciente.</div>
          </div>
          <div class="form-group col-md-6">
            <label>Procedimento</label>
            <select id="q-proc" class="form-control" required>
              <option value="">Selecione…</option>
              <option value="RESTAURACAO">Restauração</option>
              <option value="CLAREAMENTO">Clareamento</option>
              <option value="ENDODONTIA">Endodontia</option>
              <option value="PROFILAXIA">Profilaxia + Consulta</option>
            </select>
            <div class="invalid-feedback">Escolha o procedimento.</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-4">
            <label>Valor (R$)</label>
            <input id="q-valor" type="number" min="0" step="1" class="form-control" required>
            <div class="invalid-feedback">Informe o valor.</div>
          </div>
          <div class="form-group col-md-4">
            <label>Validade</label>
            <input id="q-validade" type="date" class="form-control">
          </div>
          <div class="form-group col-md-4">
            <label>Status</label>
            <select id="q-status" class="form-control">
              <option>Rascunho</option>
              <option>Enviado</option>
              <option>Aprovado</option>
              <option>Recusado</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Observações</label>
          <textarea id="q-notes" class="form-control" rows="2" placeholder="Observações para o paciente…"></textarea>
        </div>

        <!-- Breakdown vindo do cálculo de custo -->
        <input type="hidden" id="q-costing-json" />
        <small class="text-muted d-block">Se você calcular o custo antes, o preço sugerido será aplicado aqui automaticamente.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary btn-pill" type="submit">Salvar orçamento</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= JS ======= -->
<script>
(function(){
  // Abrir/fechar sidebar no mobile
  const app = document.querySelector('.crm-app');
  const btn = document.getElementById('btn-sidebar');
  const overlay = document.getElementById('crm-overlay');
  function close(){ app.classList.remove('sidebar-open'); }
  function toggle(){ app.classList.toggle('sidebar-open'); }
  btn?.addEventListener('click', toggle);
  overlay?.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
  document.querySelectorAll('.crm-nav a').forEach(a=> a.addEventListener('click', close));
})();
</script>

<script>
/* ================= MODAL DE CUSTO ================= */
(function(){
  // taxas da maquininha (alíquota sobre o valor recebido)
  const CARD_FEES = { pix: 0.00, debit: 0.015, credit_1x: 0.035, credit_2_6x: 0.049 };

  // catálogo de materiais (mock – troque por GET /materials)
  const MATERIALS = [
    { code:'resina',  name:'Resina composta',     unit:'g',      unitCost: 6.00 },
    { code:'acido',   name:'Ácido fosfórico',     unit:'mL',     unitCost: 0.80 },
    { code:'bond',    name:'Adesivo/Bond',        unit:'gotas',  unitCost: 0.60 },
    { code:'luva',    name:'Luva (par)',          unit:'par',    unitCost: 1.20 },
    { code:'kit_est', name:'Kit esterilização',   unit:'kit',    unitCost: 4.00 },
    { code:'anest',   name:'Anestesia',           unit:'tubete', unitCost: 2.50 },
  ];

  // template por procedimento (mock – troque por GET /procedure_materials?code=XYZ)
  const PROC_TEMPLATES = {
    'RESTAURACAO': [
      { code:'resina', qty:0.5, waste:5 },
      { code:'acido',  qty:0.1, waste:0 },
      { code:'bond',   qty:2,   waste:0 },
      { code:'luva',   qty:1,   waste:0 },
      { code:'kit_est',qty:1,   waste:0 },
      { code:'anest',  qty:1,   waste:0 },
    ]
  };

  const el = (q,r=document)=>r.querySelector(q);
  const cur = n => (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const pct = n => `${(n*100).toFixed(1)}%`;
  const findMat = c => MATERIALS.find(m=>m.code===c);

  function addRow(mat={ code:'', name:'', unit:'', unitCost:0 }, qty=1, waste=0){
    const tb = el('#tbl-mats tbody');
    const tr = document.createElement('tr');

    const opts = MATERIALS.map(m=>`<option value="${m.code}">${m.name}</option>`).join('');
    tr.innerHTML = `
      <td style="min-width:240px">
        <select class="form-control form-control-sm c-mat">${opts}</select>
      </td>
      <td><input type="number" min="0" step="0.01" class="form-control form-control-sm text-right c-qty" value="${qty}"></td>
      <td><input type="text" class="form-control form-control-sm c-unit" value="${mat.unit||''}" readonly></td>
      <td><input type="number" min="0" step="0.01" class="form-control form-control-sm text-right c-cost" value="${(mat.unitCost??0).toFixed(2)}"></td>
      <td><input type="number" min="0" step="1" class="form-control form-control-sm text-right c-waste" value="${waste}"></td>
      <td class="text-right c-sub">R$ 0,00</td>
      <td class="text-right"><button type="button" class="btn btn-sm btn-outline-secondary btn-pill c-del">Remover</button></td>
    `;
    tb.appendChild(tr);

    const sel  = el('.c-mat',tr);
    const unit = el('.c-unit',tr);
    const cost = el('.c-cost',tr);

    const setMat = code=>{
      const m = findMat(code); if(!m) return;
      unit.value = m.unit||'';
      cost.value = Number(m.unitCost||0).toFixed(2);
      update();
    };

    sel.addEventListener('change', ()=> setMat(sel.value));
    el('.c-qty',tr).addEventListener('input', update);
    cost.addEventListener('input', update);
    el('.c-waste',tr).addEventListener('input', update);
    el('.c-del',tr).addEventListener('click', ()=>{ tr.remove(); update(); });

    if(mat.code){ sel.value=mat.code; setMat(mat.code); } else update();
  }

  function readRows(){
    return Array.from(document.querySelectorAll('#tbl-mats tbody tr')).map(tr=>{
      const code  = tr.querySelector('.c-mat').value;
      const name  = (findMat(code)||{}).name || '';
      const qty   = Number(tr.querySelector('.c-qty').value||0);
      const unit  = tr.querySelector('.c-unit').value||'';
      const cost  = Number(tr.querySelector('.c-cost').value||0);
      const waste = Number(tr.querySelector('.c-waste').value||0);
      const effQty= qty * (1 + waste/100);
      const subtotal = effQty * cost;
      tr.querySelector('.c-sub').textContent = cur(subtotal);
      return { code,name,qty,unit,unitCost:cost,wastePct:waste,subtotal };
    });
  }

  function calc(){
    const duration = Number(el('#cst-duration').value||0);
    const hourly   = Number(el('#cst-hourly').value||0);
    const price    = Number(el('#cst-price').value||0);
    const pay      = el('#cst-pay').value;
    const taxPct   = Number(el('#cst-tax').value||0)/100;
    const feePct   = CARD_FEES[pay] || 0;

    const mats    = readRows();
    const matCost = mats.reduce((a,b)=>a+b.subtotal,0);
    const chair   = (duration/60)*hourly;

    const baseCost = matCost + chair;
    const feeValue = price * feePct;
    const taxValue = price * taxPct;
    const totalCostAtPrice = baseCost + feeValue + taxValue;
    const profit = Math.max(0, price - totalCostAtPrice);
    const margin = price>0 ? (profit/price) : 0;

    const target = Number(el('#cst-target').value||40)/100;
    const denom  = 1 - feePct - taxPct - target;
    const suggested = denom>0 ? baseCost/denom : 0;

    // UI
    el('#cst-breakdown').innerHTML = `
      <li class="d-flex justify-content-between"><span>Materiais</span><span>${cur(matCost)}</span></li>
      <li class="d-flex justify-content-between"><span>Hora clínica</span><span>${cur(chair)}</span></li>
      <li class="d-flex justify-content-between"><span>Taxa maquininha (${pct(feePct)})</span><span>${cur(feeValue)}</span></li>
      <li class="d-flex justify-content-between"><span>Impostos (${pct(taxPct)})</span><span>${cur(taxValue)}</span></li>
    `;
    el('#cst-total').textContent   = cur(totalCostAtPrice || baseCost);
    el('#cst-price-lbl').textContent = cur(price);
    el('#cst-profit').textContent  = cur(profit);
    el('#cst-margin').textContent  = `${(margin*100).toFixed(1)}%`;
    el('#cst-price-sugg').textContent = cur(suggested);
    el('#cst-target-lbl').textContent = Math.round(target*100);
    el('#cst-fee-label').textContent  = `Taxa: ${(feePct*100).toFixed(1)}% (${el('#cst-pay').selectedOptions[0].text})`;

    return {
      inputs: { durationMin:duration, hourlyCost:hourly, price, payment:pay, taxPct, feePct, targetMargin:target },
      materials: mats,
      baseCost: +baseCost.toFixed(2),
      feeValue: +feeValue.toFixed(2),
      taxValue: +taxValue.toFixed(2),
      totalCostAtPrice: +totalCostAtPrice.toFixed(2),
      profit: +profit.toFixed(2),
      margin: +margin.toFixed(4),
      suggestedPrice: +suggested.toFixed(2)
    };
  }

  function update(){ calc(); }

  // eventos de entrada
  ['#cst-duration','#cst-hourly','#cst-price','#cst-pay','#cst-tax','#cst-target']
    .forEach(id => document.querySelector(id).addEventListener('input', update));
  document.getElementById('btn-add-mat').addEventListener('click', ()=> addRow({},1,0));

  // submit → emite evento com breakdown e fecha modal
  document.getElementById('cost-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const data = calc();
    document.dispatchEvent(new CustomEvent('costing:apply', { detail: data }));
    $('#md-costing').modal('hide');
  });

  // API pública
  window.openCostModal = function({ procedureCode='RESTAURACAO', procedureName='Restauração', durationMin=60, basePrice=0 }={}){
    document.getElementById('cst-title').textContent = procedureName;
    document.getElementById('cst-proc-code').textContent = procedureCode;
    document.getElementById('cst-duration').value = durationMin;
    document.getElementById('cst-price').value = basePrice;

    // materiais
    document.querySelector('#tbl-mats tbody').innerHTML = '';
    (PROC_TEMPLATES[procedureCode]||[]).forEach(t=>{
      const mat = MATERIALS.find(m=>m.code===t.code) || { code:'', name:'', unit:'', unitCost:0 };
      addRow(mat, t.qty, t.waste||0);
    });
    if (!document.querySelector('#tbl-mats tbody').children.length){
      addRow(MATERIALS[0],1,0);
    }

    $('#md-costing').modal('show');
    setTimeout(update, 50);
  };

  // Botão do topo
  document.getElementById('btn-cost-open').addEventListener('click', ()=>{
    openCostModal({ procedureCode:'RESTAURACAO', procedureName:'Restauração', durationMin:60, basePrice:0 });
  });

  // Integração com novo orçamento
  let lastCosting = null;
  document.addEventListener('costing:apply', (e)=>{
    lastCosting = e.detail;
    // abre o modal de orçamento já com preço sugerido
    document.getElementById('q-valor').value = lastCosting.suggestedPrice || 0;
    document.getElementById('q-costing-json').value = JSON.stringify(lastCosting);
    // escolha padrão de procedimento
    document.getElementById('q-proc').value = 'RESTAURACAO';
    $('#md-new-quote').modal('show');
  });

})();
</script>

<script>
/* ================= MODAL NOVO ORÇAMENTO ================= */
(function(){
  const el = (q,r=document)=>r.querySelector(q);
  const tbody = document.getElementById('tbl-orcamentos');
  let seq = 130; // contador simples para ID fake

  function cur(n){ return (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

  // abrir modal novo orçamento (sem cálculo prévio)
  document.getElementById('btn-new-quote').addEventListener('click', ()=>{
    document.getElementById('quote-form').reset();
    document.getElementById('q-costing-json').value = '';
    $('#md-new-quote').modal('show');
  });

  // salvar orçamento (mock local – substitua por POST /odonto/budgets)
  document.getElementById('quote-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const form = e.currentTarget;
    form.classList.add('was-validated');
    if(!form.checkValidity()) return;

    const pac   = el('#q-paciente').value.trim();
    const proc  = el('#q-proc').value;
    const val   = Number(el('#q-valor').value||0);
    const stat  = el('#q-status').value;
    const valdt = el('#q-validade').value;
    const id    = `00${++seq}`;

    const badge =
      stat==='Aprovado' ? '<span class="badge-soft bg-soft-green">Aprovado</span>' :
      stat==='Enviado'  ? '<span class="badge-soft bg-soft-amber">Enviado</span>' :
      stat==='Recusado' ? '<span class="badge-soft bg-soft-red">Recusado</span>' :
                          '<span class="badge-soft">Rascunho</span>';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${pac}</td>
      <td>${proc}</td>
      <td>${cur(val)}</td>
      <td>${badge}</td>
      <td>${valdt ? valdt.split('-').reverse().join('/') : '—'}</td>
      <td><a class="btn btn-sm btn-outline-secondary btn-pill">Ver</a></td>
    `;
    tbody.prepend(tr);

    $('#md-new-quote').modal('hide');
    form.classList.remove('was-validated');
  });
})();
</script>

<!-- JS libs (necessário para os modais) -->
<script src="../js/jquery-3.4.1.min.js"></script>
<script src="../js/bootstrap.js"></script>

<!-- BOTTOM BAR (visível apenas no mobile) -->
<nav class="bb-dribbble" id="bbBar" aria-label="Navegação rápida">
  <svg class="bb-bg" viewBox="0 0 1000 160" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <filter id="bbShadow" x="-20%" y="-50%" width="140%" height="200%">
        <feDropShadow dx="0" dy="14" stdDeviation="12" flood-color="rgba(15,23,42,.10)"/>
        <feDropShadow dx="0" dy="4"  stdDeviation="6"  flood-color="rgba(15,23,42,.08)"/>
      </filter>
    </defs>
    <path id="bbPath" class="bb-path" filter="url(#bbShadow)"
      d="M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z" />
    <animate id="bbMorph" xlink:href="#bbPath" attributeName="d" dur="420ms" fill="freeze"
      values="
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H330 C400,26 440,-18 500,-18 C560,-18 600,26 670,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z
      " />
  </svg>

  <button class="bb-tab" data-act="agenda" aria-label="Agenda">
    <i class="fa-regular fa-calendar-days"></i><span>Agenda</span>
  </button>
  <button class="bb-fab" data-act="quick" aria-label="Ações rápidas">
    <i class="fa-solid fa-plus"></i>
  </button>
  <button class="bb-tab" data-act="menu" aria-label="Menu">
    <i class="fa-solid fa-list-ul"></i><span>Menu</span>
  </button>
</nav>

<script>
(function(){
  const bar = document.getElementById('bbBar');
  if(!bar) return;
  const tabAgenda = bar.querySelector('.bb-tab[data-act="agenda"]');
  const tabMenu   = bar.querySelector('.bb-tab[data-act="menu"]');
  const fab       = bar.querySelector('.bb-fab');
  const morph     = document.getElementById('bbMorph');

  const openSheet = el => { /* se tiver sheets nesta página, abra aqui */ };
  function wave(){ try{ morph.beginElement(); }catch(e){} }
  function bounce(el){ const i=el.querySelector('i'),s=el.querySelector('span'); i&&i.classList.remove('bb-bounce'); s&&s.classList.remove('bb-bounce'); void i?.offsetWidth; void s?.offsetWidth; i&&i.classList.add('bb-bounce'); s&&s.classList.add('bb-bounce'); }

  tabAgenda.addEventListener('click', ()=>{ wave(); bounce(tabAgenda); setTimeout(()=>location.href='agenda.html',120); });
  tabMenu.addEventListener('click', ()=>{ wave(); bounce(tabMenu); /* abrir sheet de menu se existir */ });
  fab.addEventListener('click', ()=>{ wave(); bounce(fab); /* abrir ações rápidas se existir */ });
})();
</script>

</body>
</html>
