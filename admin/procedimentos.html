<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CRM Odonto – Procedimentos</title>

  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="css/crm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Sidebar (menu mobile) -->
  <script src="js/sidebar.js" defer></script>
</head>
<body data-page="procedimentos">

<div class="crm-app">
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <!-- mantenha o mesmo org id usado no restante do app -->
    <input type="hidden" id="org-id" value="6f8b8f6b-1e34-4d3f-9bcd-9b0acb5f0abc" />

    <nav class="crm-nav">
      <a href="inicio.html" data-nav="inicio"><i class="fa-solid fa-grid-2"></i> Início</a>
      <a href="agenda.html" data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html" data-nav="pacientes"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html" data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html" data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <!-- overlay mobile -->
  <div class="crm-overlay" id="crm-overlay"></div>

  <!-- MAIN -->
  <main class="crm-main">
    <!-- Burger (mobile) -->
    <button class="crm-burger" id="btn-sidebar" aria-label="Abrir menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <section class="crm-hero">
      <h1 class="text-center mb-1">Procedimentos</h1>
      <div class="crm-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="proc-q" placeholder="Buscar por nome, código, duração..." />
        <button id="proc-search-btn" class="btn btn-sm btn-outline-secondary btn-pill">Buscar</button>
        <a href="#" class="btn btn-sm btn-primary btn-pill ml-auto">
          <i class="fa-solid fa-tooth mr-1"></i> Novo procedimento
        </a>
      </div>
    </section>

    <section class="crm-content">
      <div class="crm-card">
        <div class="d-flex justify-content-end mb-2">
          <button id="proc-reload" class="btn btn-sm btn-outline-secondary btn-pill">Recarregar</button>
        </div>

        <table class="table mb-0" id="proc-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Duração</th>
              <th>Preço</th>
              <th>Código</th>
              <th class="text-right"></th>
            </tr>
          </thead>
          <tbody id="proc-tbody">
            <tr>
              <td colspan="5" class="text-center text-muted">Carregando…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- libs -->
<script src="../js/jquery-3.4.1.min.js"></script>
<script src="../js/bootstrap.js"></script>

<!-- Config do n8n (sem barra no final) -->
<script>
  window.CRM_API_BASE = 'https://allnsnts.app.n8n.cloud/webhook/odonto';
</script>

<script>
(function () {
  // ====== util ======
  const API_BASE = (window.CRM_API_BASE || '').replace(/\/+$/,'');
  const qs  = (obj)=> {
    const p = new URLSearchParams();
    Object.entries(obj||{}).forEach(([k,v])=>{
      if(v!==undefined && v!==null && v!=='') p.append(k, String(v));
    });
    const s = p.toString();
    return s ? '?' + s : '';
  };
  const toBRL = (v)=> (Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  // ====== DOM ======
  const tbody   = document.getElementById('proc-tbody');
  const qInput  = document.getElementById('proc-q');
  const btnFind = document.getElementById('proc-search-btn');
  const btnReload = document.getElementById('proc-reload');
  const ORG_ID = document.getElementById('org-id')?.value || null;

  // ====== data cache ======
  let PROC_CACHE = [];

  // ====== API ======
  async function fetchProcedures() {
    const url = API_BASE + '/procedures' + qs({ org_id: ORG_ID });
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }, cache:'no-store' });
    const text = await res.text();
    let data; try { data = JSON.parse(text); } catch { data = text; }
    if (!res.ok) throw new Error((data && (data.message || data.error?.message)) || res.statusText || 'Erro ao carregar');
    return Array.isArray(data) ? data : (data.items || []);
  }

  // ====== render ======
  function render(rows) {
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum procedimento encontrado</td></tr>';
      return;
    }
    rows.forEach(p => {
      const tr = document.createElement('tr');
      const dur = (p.default_duration_min ?? p.duration ?? 60) + ' min';
      const price = toBRL(p.price || 0);
      tr.innerHTML = `
        <td>${p.name || '-'}</td>
        <td>${dur}</td>
        <td>${price}</td>
        <td>${p.code || '-'}</td>
        <td class="text-right">
          <a href="#" class="btn btn-sm btn-outline-secondary btn-pill" data-id="${p.id || ''}">Editar</a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // ====== load + filter ======
  async function load() {
    try {
      btnReload?.setAttribute('disabled','disabled');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando…</td></tr>';
      PROC_CACHE = await fetchProcedures();
      render(PROC_CACHE);
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message || 'Erro ao carregar'}</td></tr>`;
    } finally {
      btnReload?.removeAttribute('disabled');
    }
  }

  function applyFilter() {
    const q = qInput.value.trim().toLowerCase();
    if (!q) { render(PROC_CACHE); return; }
    const filtered = PROC_CACHE.filter(p => {
      const dur = String(p.default_duration_min ?? p.duration ?? '');
      return [p.name, p.code, dur].some(v => (v || '').toString().toLowerCase().includes(q));
    });
    render(filtered);
  }

  // eventos
  btnReload?.addEventListener('click', e => { e.preventDefault(); load(); });
  btnFind?.addEventListener('click', e => { e.preventDefault(); applyFilter(); });
  qInput?.addEventListener('keyup', e => { if (e.key === 'Enter') applyFilter(); });

  // sidebar mobile handlers já estão no sidebar.js (carregado com defer)

  // primeira carga
  load();
})();
</script>

</body>
</html>
