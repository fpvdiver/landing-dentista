<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CRM Odonto – Procedimentos</title>
  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="css/crm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Sidebar (deixe como estiver no seu projeto; se esse caminho 404, ajuste) -->
  <script src="js/sidebar.js" defer></script>
</head>
<body data-page="procedimentos">

<div class="crm-app">
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <!-- Mantenha um org_id disponível (ajuste para o seu) -->
    <input type="hidden" id="org-id" value="6f8b8f6b-1e34-4d3f-9bcd-9b0acb5f0abc" />

    <nav class="crm-nav">
      <a href="inicio.html" data-nav="inicio"><i class="fa-solid fa-grid-2"></i> Início</a>
      <a href="agenda.html" data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html" data-nav="pacientes"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html" data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html" data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <div class="crm-overlay" id="crm-overlay"></div>

  <main class="crm-main">
    <button class="crm-burger" id="btn-sidebar" aria-label="Abrir menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <section class="crm-hero">
      <h1 class="text-center mb-1">Procedimentos</h1>
      <div class="crm-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="proc-q" placeholder="Buscar por nome, código, duração..." />
        <button id="proc-search-btn" class="btn btn-sm btn-outline-secondary btn-pill">Buscar</button>
        <a href="#" class="btn btn-sm btn-primary btn-pill ml-auto">
          <i class="fa-solid fa-tooth mr-1"></i> Novo procedimento
        </a>
      </div>
    </section>

    <section class="crm-content">
      <div class="crm-card">
        <div class="d-flex justify-content-end mb-2">
          <button id="proc-reload" class="btn btn-sm btn-outline-secondary btn-pill">Recarregar</button>
        </div>
        <table class="table mb-0">
          <thead>
            <tr><th>Nome</th><th>Duração</th><th>Preço</th><th>Código</th><th></th></tr>
          </thead>
          <tbody id="proc-tbody">
            <tr><td colspan="5" class="text-center text-muted">Carregando…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
/* Sidebar mobile */
(function () {
  const app = document.querySelector('.crm-app');
  const btn = document.getElementById('btn-sidebar');
  const overlay = document.getElementById('crm-overlay');
  function close(){ app.classList.remove('sidebar-open'); }
  function toggle(){ app.classList.toggle('sidebar-open'); }
  btn?.addEventListener('click', toggle);
  overlay?.addEventListener('click', close);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  document.querySelectorAll('.crm-nav a').forEach(a => a.addEventListener('click', close));
})();
</script>

<!-- Config da API n8n (ajuste se usar outro domínio) -->
<script>
  window.CRM_API_BASE = 'https://allnsnts.app.n8n.cloud/webhook/odonto';
</script>

<script>
(function () {
  const API_BASE = (window.CRM_API_BASE || 'https://allnsnts.app.n8n.cloud/webhook/odonto').replace(/\/+$/,'');
  const qs = (obj)=> {
    const p = new URLSearchParams();
    Object.entries(obj||{}).forEach(([k,v])=>{
      if(v!==undefined && v!==null && v!=='') p.append(k, String(v));
    });
    const s = p.toString();
    return s ? '?' + s : '';
  };
  const toBRL = (v)=> (Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  const tbody   = document.getElementById('proc-tbody');
  const qInput  = document.getElementById('proc-q');
  const btnFind = document.getElementById('proc-search-btn');
  const btnReload = document.getElementById('proc-reload');
  const ORG_ID = document.getElementById('org-id')?.value || null;

  let PROC_CACHE = [];

  // Aceita vários formatos de saída do n8n
  function unwrapList(data) {
    if (Array.isArray(data)) {
      if (data.length && data[0] && typeof data[0] === 'object' && 'json' in data[0]) {
        return data.map(x => x.json);
      }
      return data;
    }
    if (!data || typeof data !== 'object') return [];
    const candidates = data.items || data.data || data.result || data.records || data.rows;
    if (Array.isArray(candidates)) {
      if (candidates.length && typeof candidates[0] === 'object' && 'json' in candidates[0]) {
        return candidates.map(x => x.json);
      }
      return candidates;
    }
    if (data.json && typeof data.json === 'object') return [data.json];
    if (Object.keys(data).length && !('message' in data)) return [data];
    return [];
  }

  async function fetchProcedures() {
    const url = API_BASE + '/procedures' + qs({ org_id: ORG_ID });
    const res = await fetch(url, { method:'GET', headers:{'Accept':'application/json'}, cache:'no-store' });
    const text = await res.text();
    let data; try { data = JSON.parse(text); } catch { data = text; }
    console.log('procedures/raw:', data); // debug
    if (!res.ok) {
      const msg = (data && (data.message || data.error?.message)) || res.statusText || 'Erro ao carregar';
      throw new Error(msg);
    }
    return unwrapList(data);
  }

  function render(rows) {
    tbody.innerHTML = '';
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum procedimento encontrado</td></tr>';
      return;
    }
    rows.forEach(p => {
      const durMin = (p.default_duration_min ?? p.duration ?? 60);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name || '-'}</td>
        <td>${durMin} min</td>
        <td>${toBRL(p.price || 0)}</td>
        <td>${p.code || '-'}</td>
        <td class="text-right">
          <a href="#" class="btn btn-sm btn-outline-secondary btn-pill" data-id="${p.id || ''}">Editar</a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  async function load() {
    try {
      btnReload?.setAttribute('disabled','disabled');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando…</td></tr>';
      PROC_CACHE = await fetchProcedures();
      render(PROC_CACHE);
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message || 'Erro ao carregar'}</td></tr>`;
    } finally {
      btnReload?.removeAttribute('disabled');
    }
  }

  function applyFilter() {
    const q = qInput.value.trim().toLowerCase();
    if (!q) { render(PROC_CACHE); return; }
    const filtered = PROC_CACHE.filter(p => {
      const dur = String(p.default_duration_min ?? p.duration ?? '');
      return [p.name, p.code, dur].some(v => (v || '').toString().toLowerCase().includes(q));
    });
    render(filtered);
  }

  btnReload?.addEventListener('click', e => { e.preventDefault(); load(); });
  btnFind?.addEventListener('click', e => { e.preventDefault(); applyFilter(); });
  qInput?.addEventListener('keyup', e => { if (e.key === 'Enter') applyFilter(); });

  load();
})();
</script>

<script src="../js/jquery-3.4.1.min.js"></script>
<script src="../js/bootstrap.js"></script>

<script>
  // Base da API (n8n)
  window.CRM_API_BASE = 'https://allnsnts.app.n8n.cloud/webhook/odonto';
</script>

<script>
(function () {
  const API_BASE = (window.CRM_API_BASE || '').replace(/\/+$/,'');
  const tbody    = document.getElementById('proc-tbody');
  const qInput   = document.getElementById('proc-q');
  const btnFind  = document.getElementById('proc-search-btn');
  const btnReload= document.getElementById('proc-reload');
  const ORG_ID   = document.getElementById('org-id')?.value || null;

  const toBRL = v => (Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const qs    = o => {
    const p = new URLSearchParams();
    Object.entries(o||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') p.append(k, String(v)); });
    return p.toString() ? '?' + p.toString() : '';
  };

  // Desembrulha qualquer formato comum do n8n
  function unwrapList(data){
    try{
      if(Array.isArray(data)){
        // array de objetos json
        if(data.length && data[0] && typeof data[0]==='object' && 'json' in data[0]){
          return data.map(x=>x.json);
        }
        return data;
      }
      if(!data || typeof data!=='object') return [];
      // candidatos usuais
      const cand = data.items || data.data || data.result || data.records || data.rows || data.list;
      if(Array.isArray(cand)){
        if(cand.length && cand[0] && typeof cand[0]==='object' && 'json' in cand[0]){
          return cand.map(x=>x.json);
        }
        return cand;
      }
      if(data.json && typeof data.json==='object') return [data.json];

      // última tentativa: alguma key que seja array de objetos
      const arrLike = Object.values(data).find(v => Array.isArray(v) && v.length && typeof v[0]==='object');
      if(arrLike) return arrLike;

      return [];
    }catch{ return []; }
  }

  let CACHE = [];

  async function fetchProcedures(){
    const url = API_BASE + '/procedures' + qs({ org_id: ORG_ID });
    const res = await fetch(url, { method:'GET', headers:{Accept:'application/json'}, cache:'no-store' });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ data = text; }
    console.log('procedures/raw:', data); // DEBUG: veja no console como veio

    if(!res.ok){
      const msg = (data && (data.message || data.error?.message)) || res.statusText || 'Erro ao carregar';
      throw new Error(msg);
    }
    return unwrapList(data);
  }

  function render(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length===0){
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum procedimento encontrado</td></tr>';
      return;
    }
    rows.forEach(p=>{
      const durMin = p.default_duration_min ?? p.duration ?? 60;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name || '-'}</td>
        <td>${durMin} min</td>
        <td>${toBRL(p.price || 0)}</td>
        <td>${p.code || '-'}</td>
        <td class="text-right"><a class="btn btn-sm btn-outline-secondary btn-pill" data-id="${p.id||''}" href="#">Editar</a></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function load(){
    try{
      btnReload?.setAttribute('disabled','disabled');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando…</td></tr>';
      CACHE = await fetchProcedures();
      render(CACHE);
    }catch(err){
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message || 'Erro ao carregar'}</td></tr>`;
    }finally{
      btnReload?.removeAttribute('disabled');
    }
  }

  function applyFilter(){
    const q = (qInput?.value || '').trim().toLowerCase();
    if(!q){ render(CACHE); return; }
    const filtered = CACHE.filter(p=>{
      const dur = String(p.default_duration_min ?? p.duration ?? '');
      return [p.name, p.code, dur].some(v => (v||'').toString().toLowerCase().includes(q));
    });
    render(filtered);
  }

  btnReload?.addEventListener('click', e => { e.preventDefault(); load(); });
  btnFind?.addEventListener('click', e => { e.preventDefault(); applyFilter(); });
  qInput?.addEventListener('keyup', e => { if(e.key==='Enter') applyFilter(); });

  load();
})();
</script>

<script>
  window.CRM_API_BASE = 'https://allnsnts.app.n8n.cloud/webhook/odonto';

  function unwrapList(data){
    return Array.isArray(data) ? data : (data?.items || data?.data || []);
  }
  const toBRL = v => (Number(v||0)).toLocaleString('pt-BR',{ style:'currency', currency:'BRL' });

  async function loadProcedures(){
    const orgId = document.getElementById('org-id')?.value || '6f8b8f6b-1e34-4d3f-9bcd-9b0acb5f0abc';
    const res = await fetch(`${window.CRM_API_BASE}/procedures?org_id=${orgId}`, {
      headers: { Accept: 'application/json' }
    });
    const data = await res.json();
    const rows = unwrapList(data);

    const tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';

    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhum procedimento encontrado</td></tr>`;
      return;
    }

    rows.forEach(p => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${p.name}</td>
          <td>${p.default_duration_min || 60} min</td>
          <td>${toBRL(p.price)}</td>
          <td>${p.code || '-'}</td>
          <td class="text-right">
            <a class="btn btn-sm btn-outline-secondary btn-pill">Editar</a>
          </td>
        </tr>
      `);
    });
  }

  document.addEventListener('DOMContentLoaded', loadProcedures);
  document.getElementById('btn-recarregar')?.addEventListener('click', loadProcedures);
</script>


</body>
</html>


