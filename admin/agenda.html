<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda — Clínica</title>

  <!-- Bootstrap (CDN) para grid/tabela básica -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>

  <style>
    :root{
      --ring:#e5e7eb;
      --muted:#64748b;
      --soft:#f8fafc;
    }
    body{ background:#f6f7fb; }
    .crm-wrap{ max-width: 1100px; margin: 24px auto 48px; }
    .crm-card{ background:#fff; border:1px solid var(--ring); border-radius:12px; box-shadow:0 4px 16px rgba(15,23,42,.06); }
    .crm-card .card-body{ padding: 14px 16px; }
    h1{ font-weight:800; font-size: 1.6rem; }
    .muted{ color:var(--muted); }
    .toolbar{ display:flex; align-items:center; gap:.5rem; }
    .toolbar .btn{ border-radius: 999px; }
    .kpis{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
    .kpi{ background:#fff; border:1px solid var(--ring); border-radius:12px; padding:.75rem; }
    .kpi .lab{ color:var(--muted); font-size:.8rem }
    .kpi .val{ font-weight:800; font-size:1.25rem }
    .table thead th{ border-top:0; background:var(--soft); }
    .badge-soft{ border:1px solid var(--ring); padding:.25rem .45rem; border-radius:999px; font-weight:600; background:#fff; }
    .bg-soft-green{ background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .bg-soft-amber{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
    .bg-soft-red{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    .bg-soft-gray{ background:#f3f4f6; border-color:#e5e7eb; color:#374151; }
    .legend{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .legend .chip{ padding:.25rem .6rem; border:1px solid var(--ring); border-radius:999px; cursor:pointer; user-select:none; }
    .legend .chip.active{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .status-cell{ width: 150px; }
  </style>
</head>
<body>
  <div class="crm-wrap">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">Agenda</h1>
      <div class="toolbar">
        <input type="date" id="flt-date" class="form-control form-control-sm"/>
        <button class="btn btn-sm btn-outline-secondary" id="btn-prev-day">Dia anterior</button>
        <button class="btn btn-sm btn-outline-secondary" id="btn-today">Hoje</button>
        <button class="btn btn-sm btn-outline-secondary" id="btn-next-day">Próximo dia</button>
      </div>
    </div>

    <div class="crm-card mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <div class="muted">Dia</div>
          <div class="h5 mb-0" id="agenda-title">—</div>
          <div class="muted" id="agenda-intervalo" style="font-size:.85rem">—</div>
        </div>
        <div class="legend">
          <div class="chip active" data-filter="all">Todos</div>
          <div class="chip" data-filter="confirmado">Confirmados</div>
          <div class="chip" data-filter="pendente">Pendentes</div>
          <div class="chip" data-filter="cancelado">Cancelados</div>
        </div>
      </div>
    </div>

    <div class="kpis mb-3">
      <div class="kpi">
        <div class="lab">Agendamentos</div>
        <div class="val" id="kpi-total">—</div>
      </div>
      <div class="kpi">
        <div class="lab">Confirmados</div>
        <div class="val" id="kpi-conf">—</div>
      </div>
      <div class="kpi">
        <div class="lab">Pendentes</div>
        <div class="val" id="kpi-pend">—</div>
      </div>
      <div class="kpi">
        <div class="lab">Cancelados</div>
        <div class="val" id="kpi-canc">—</div>
      </div>
    </div>

    <div class="crm-card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th style="width:90px">Hora</th>
                <th>Paciente</th>
                <th>Procedimento</th>
                <th class="status-cell">Status</th>
                <th style="width:120px">Dentista</th>
                <th style="width:100px">Sala</th>
              </tr>
            </thead>
            <tbody id="agenda-tbody">
              <tr><td colspan="6">Carregando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ===== CONFIG =====
    const CRM_API_BASE = 'https://primary-odonto.up.railway.app/webhook/odonto';
    const TIMEZONE     = 'America/Sao_Paulo';

    // ===== Helpers =====
    const pad2 = n => String(n).padStart(2, '0');
    const ymdToday = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
    const fmtBR = iso => { try{ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; }catch{ return iso; } };

    function statusBadge(s=''){
      s = (s||'').toLowerCase();
      if (s.includes('confirm')) return '<span class="badge-soft bg-soft-green">Confirmado</span>';
      if (s.includes('cancel'))  return '<span class="badge-soft bg-soft-red">Cancelado</span>';
      // qualquer outro -> pendente
      return '<span class="badge-soft bg-soft-amber">Pendente</span>';
    }

    function rangeSlots(start,end,step){
      const out=[], [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number);
      let d=new Date(); d.setHours(sh,sm,0,0); const z=new Date(); z.setHours(eh,em,0,0);
      while(d<z){ out.push(`${pad2(d.getHours())}:${pad2(d.getMinutes())}`); d=new Date(d.getTime()+step*60000); }
      return out;
    }

    function computeKPIs(events=[]){
      const k = { total:0, conf:0, pend:0, canc:0 };
      (events||[]).forEach(ev=>{
        k.total++;
        const s = (ev.status||'').toLowerCase();
        if (s.includes('confirm')) k.conf++;
        else if (s.includes('cancel')) k.canc++;
        else k.pend++;
      });
      return k;
    }

    // ===== API =====
    async function fetchDay(dateStr){
      const url = `${CRM_API_BASE}/appointments/day?date=${encodeURIComponent(dateStr)}&tz=${encodeURIComponent(TIMEZONE)}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' } });
      if(!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(t || 'Falha ao buscar agenda');
      }
      return res.json();
    }

    // ===== Render =====
    function renderDay(tbody, dayData, filter='all'){
      const start = dayData.officeHours?.start || '08:00';
      const end   = dayData.officeHours?.end   || '19:00';
      const step  = dayData.intervalMinutes ?? 60;

      const slots = rangeSlots(start,end,step);
      const events = dayData.events || [];
      const byStart = {};
      events.forEach(ev => { if (ev?.start) byStart[ev.start] = ev; });

      tbody.innerHTML = '';
      slots.forEach(hhmm=>{
        const ev = byStart[hhmm];
        if (!ev) {
          if (filter==='all') {
            tbody.insertAdjacentHTML('beforeend', `
              <tr>
                <td>${hhmm}</td>
                <td class="text-muted">—</td>
                <td class="text-muted">—</td>
                <td class="status-cell">${statusBadge('livre')}</td>
                <td>—</td>
                <td>—</td>
              </tr>
            `);
          }
          return;
        }

        const s = (ev.status||'').toLowerCase();
        const sKey = s.includes('confirm')?'confirmado':(s.includes('cancel')?'cancelado':'pendente');
        if (filter!=='all' && filter!==sKey) return;

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${ev.start||'--:--'}</td>
            <td>${ev.patientName||'-'}</td>
            <td>${ev.procedure||'-'}</td>
            <td class="status-cell">${statusBadge(ev.status)}</td>
            <td>${ev.dentist||'—'}</td>
            <td>${ev.room||'—'}</td>
          </tr>
        `);
      });
    }

    // ===== Boot =====
    (function(){
      const dateInput   = document.getElementById('flt-date');
      const tbody       = document.getElementById('agenda-tbody');
      const titleEl     = document.getElementById('agenda-title');
      const lblInt      = document.getElementById('agenda-intervalo');
      const kTotal      = document.getElementById('kpi-total');
      const kConf       = document.getElementById('kpi-conf');
      const kPend       = document.getElementById('kpi-pend');
      const kCanc       = document.getElementById('kpi-canc');

      let filterState = 'all';
      let lastDay = null;

      async function loadDay(){
        const ds = dateInput.value || ymdToday();
        titleEl.textContent = `${fmtBR(ds)} • ${TIMEZONE.replace('_',' ')}`;
        tbody.innerHTML = '<tr><td colspan="6">Carregando…</td></tr>';

        try{
          const day = await fetchDay(ds);
          lastDay = day;
          lblInt.textContent = `Intervalo de ${day?.intervalMinutes ?? 60} min`;
          renderDay(tbody, day, filterState);

          const k = computeKPIs(day?.events || []);
          kTotal.textContent = k.total; kConf.textContent = k.conf; kPend.textContent = k.pend; kCanc.textContent = k.canc;
        }catch(e){
          console.error(e);
          tbody.innerHTML = `<tr><td colspan="6" class="text-danger">${e.message||'Erro ao carregar agenda'}</td></tr>`;
          kTotal.textContent = kConf.textContent = kPend.textContent = kCanc.textContent = '—';
        }
      }

      // Navegação
      function shiftDay(delta){
        const d = new Date(dateInput.value || ymdToday());
        d.setDate(d.getDate()+delta);
        dateInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        loadDay();
      }
      document.getElementById('btn-prev-day').addEventListener('click', ()=>shiftDay(-1));
      document.getElementById('btn-next-day').addEventListener('click', ()=>shiftDay(1));
      document.getElementById('btn-today').addEventListener('click', ()=>{ dateInput.value = ymdToday(); loadDay(); });

      // Filtro
      document.querySelectorAll('.legend .chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          document.querySelectorAll('.legend .chip').forEach(x=>x.classList.remove('active'));
          ch.classList.add('active');
          filterState = ch.dataset.filter || 'all';
          if (lastDay) renderDay(tbody, lastDay, filterState);
        });
      });

      // Boot
      dateInput.value = ymdToday();
      loadDay();
    })();
  </script>
</body>
</html>
