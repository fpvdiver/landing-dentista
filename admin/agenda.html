<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agenda Ultra — Clínica</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"/>
  <style>
    :root{
      --ring:#e5e7eb; --muted:#64748b; --soft:#f8fafc; --brand:#0ea5e9;
      --green:#10b981; --red:#ef4444; --amber:#f59e0b; --purple:#7c3aed;
    }
    body{background:#f6f7fb}
    .wrap{max-width:1240px;margin:24px auto 48px}
    .cardx{background:#fff;border:1px solid var(--ring);border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.06)}
    .cardx>.hd{padding:10px 14px;border-bottom:1px solid var(--ring);background:linear-gradient(180deg,#eef6ff 0,#fff 100%)}
    .pill{border-radius:999px}
    .muted{color:var(--muted)}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
    .kpi{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:.75rem}
    .kpi .lab{font-size:.8rem;color:var(--muted)} .kpi .val{font-weight:800;font-size:1.2rem}
    .legend .chip{padding:.25rem .6rem;border:1px solid var(--ring);border-radius:999px;cursor:pointer}
    .legend .chip.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .badge-soft{border:1px solid var(--ring);padding:.2rem .45rem;border-radius:999px;font-weight:600;background:#fff}
    .bg-soft-green{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .bg-soft-amber{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .bg-soft-red{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .bg-soft-purple{background:#f5f3ff;border-color:#ddd6fe;color:#4c1d95}
    .btn-ic{border:1px solid var(--ring);background:#fff;border-radius:8px;padding:.25rem .45rem;margin:.15rem}
    .btn-ic:hover{border-color:#cbd5e1}
    .btn-ic[disabled]{opacity:.45;cursor:not-allowed}
    .table thead th{border-top:0;background:var(--soft)}
    .right-col{min-width:330px}
    @media(max-width:1199px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:991px){.layout{display:block}.right-col{width:100%}}
  </style>
</head>
<body>
<div class="wrap">

  <!-- TOP BAR -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0 font-weight-bold">Agenda</h4>
    <div class="d-flex align-items-center">
      <input type="date" id="flt-date" class="form-control form-control-sm mr-2"/>
      <button class="btn btn-sm btn-outline-secondary pill mr-1" id="btn-prev">◀ Dia</button>
      <button class="btn btn-sm btn-outline-secondary pill mr-1" id="btn-today">Hoje</button>
      <button class="btn btn-sm btn-outline-secondary pill mr-2" id="btn-next">Dia ▶</button>
      <a href="book.html" class="btn btn-sm btn-primary pill">Novo</a>
    </div>
  </div>

  <!-- MASS ACTIONS / LEGEND -->
  <div class="cardx mb-3">
    <div class="hd d-flex align-items-center justify-content-between flex-wrap">
      <div>
        <div class="muted">Dia</div>
        <div class="h5 mb-0" id="day-title">—</div>
        <div class="muted" id="day-intv" style="font-size:.85rem">—</div>
      </div>
      <div class="legend">
        <span class="chip active" data-filter="all">Todos</span>
        <span class="chip" data-filter="confirmado">Confirmados</span>
        <span class="chip" data-filter="pendente">Pendentes</span>
        <span class="chip" data-filter="cancelado">Cancelados</span>
      </div>
      <div class="d-flex flex-wrap mt-2 mt-md-0">
        <button class="btn btn-sm btn-outline-secondary pill mr-1" id="act-confirm-pending">Confirmar pendentes</button>
        <button class="btn btn-sm btn-outline-secondary pill mr-1" id="act-send-reminders">Lembretes (WA)</button>
        <button class="btn btn-sm btn-outline-secondary pill mr-1" id="act-lunch">Bloquear almoço</button>
        <button class="btn btn-sm btn-outline-secondary pill" id="act-print">Imprimir</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpis mb-3">
    <div class="kpi"><div class="lab">Agendamentos</div><div class="val" id="kpi-total">—</div></div>
    <div class="kpi"><div class="lab">Confirmados</div><div class="val" id="kpi-conf">—</div></div>
    <div class="kpi"><div class="lab">Pendentes</div><div class="val" id="kpi-pend">—</div></div>
    <div class="kpi"><div class="lab">Cancelados</div><div class="val" id="kpi-canc">—</div></div>
    <div class="kpi"><div class="lab">Ocupação</div><div class="val"><span id="kpi-occ">—</span>% <span class="muted" style="font-size:.8rem">(<span id="kpi-hours">—</span>)</span></div></div>
    <div class="kpi"><div class="lab">Est. Faturamento</div><div class="val">R$ <span id="kpi-rev">—</span></div></div>
  </div>

  <!-- GRID + RIGHT -->
  <div class="layout d-flex">
    <div class="flex-grow-1 mr-lg-3">
      <div class="cardx">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th style="width:90px">Hora</th>
                <th>Paciente</th>
                <th>Procedimento</th>
                <th style="width:150px">Status</th>
                <th style="width:120px">Dentista</th>
                <th style="width:90px">Sala</th>
                <th style="width:260px">Ações</th>
              </tr>
            </thead>
            <tbody id="grid-body"><tr><td colspan="7">Carregando…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right-col">
      <!-- Espera -->
      <div class="cardx mb-3">
        <div class="hd"><strong>Lista de Espera</strong></div>
        <div class="p-2">
          <form id="wl-form" class="mb-2">
            <div class="form-row">
              <div class="col-6"><input class="form-control form-control-sm" placeholder="Nome" id="wl-name" required></div>
              <div class="col-6"><input class="form-control form-control-sm" placeholder="WhatsApp" id="wl-phone"></div>
            </div>
            <input class="form-control form-control-sm mt-1" placeholder="Procedimento" id="wl-proc">
            <input class="form-control form-control-sm mt-1" placeholder="Observações" id="wl-notes">
            <button class="btn btn-sm btn-outline-secondary pill mt-2 btn-block">Adicionar à lista</button>
          </form>
          <ul class="list-unstyled mb-0" id="wl-list"><li class="muted">Carregando…</li></ul>
        </div>
      </div>

      <!-- Tarefas do dia -->
      <div class="cardx mb-3">
        <div class="hd d-flex align-items-center justify-content-between">
          <strong>Tarefas do dia</strong>
          <button class="btn btn-sm btn-outline-secondary pill" id="task-add">Nova</button>
        </div>
        <div class="p-2">
          <ul id="tasks" class="list-unstyled mb-0"></ul>
        </div>
      </div>

      <!-- Notas -->
      <div class="cardx">
        <div class="hd"><strong>Notas do dia</strong></div>
        <div class="p-2">
          <ul class="mb-0" id="day-notes">
            <li>Checar estoque de anestésico.</li>
            <li>Retorno de Felipe — confirmar Raio-X.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reagendar -->
<div class="modal fade" id="md-reag" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Reagendar</h5><button class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body">
        <input type="hidden" id="md-id">
        <div class="form-row">
          <div class="form-group col-md-5">
            <label>Data</label>
            <input type="date" class="form-control" id="md-date" required>
          </div>
          <div class="form-group col-md-7">
            <label>Horários</label>
            <div id="md-slots" class="d-flex flex-wrap" style="gap:8px"></div>
            <small class="text-muted d-block mt-1">Selecione um horário disponível.</small>
            <input type="hidden" id="md-time">
          </div>
        </div>
        <div id="md-feedback" class="mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary pill" data-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary pill" id="md-save">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= CONFIG ========= */
const API_BASE = 'https://primary-odonto.up.railway.app/webhook/odonto';
const AVAIL_URL = 'https://primary-odonto.up.railway.app/webhook/availability';
const TZ = 'America/Sao_Paulo';
const CLINIC = 'Clínica Elen Nogata';

/* ========= HELPERS ========= */
const pad2 = n => String(n).padStart(2,'0');
const ymdToday = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
const fmtBR = iso => { try{ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; }catch{ return iso; } };
const toWA = raw => { if(!raw) return ''; const d=raw.replace(/\D/g,''); return d.length===11?`55${d}`:d; };

function statusBadge(s=''){
  s=(s||'').toLowerCase();
  if(s.includes('confirm')) return '<span class="badge-soft bg-soft-green">Confirmado</span>';
  if(s.includes('cancel'))  return '<span class="badge-soft bg-soft-red">Cancelado</span>';
  if(s.includes('check-in'))return '<span class="badge-soft bg-soft-purple">Check-in</span>';
  if(s.includes('concluded'))return '<span class="badge-soft">Concluído</span>';
  return '<span class="badge-soft bg-soft-amber">Pendente</span>';
}

function rangeSlots(start,end,step){
  const out=[], [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number);
  let d=new Date(); d.setHours(sh,sm,0,0); const z=new Date(); z.setHours(eh,em,0,0);
  while(d<z){ out.push(`${pad2(d.getHours())}:${pad2(d.getMinutes())}`); d=new Date(d.getTime()+step*60000); }
  return out;
}

/* ========= API ========= */
async function fetchDay(date){
  const u = `${API_BASE}/appointments/day?date=${encodeURIComponent(date)}&tz=${encodeURIComponent(TZ)}`;
  const r = await fetch(u, {headers:{Accept:'application/json'}}); if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function fetchAvailability(date){
  const u = `${AVAIL_URL}?date=${encodeURIComponent(date)}&tz=${encodeURIComponent(TZ)}`;
  const r = await fetch(u, {headers:{Accept:'application/json'}}); if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function fetchProcedures(){
  // opcional: precificação para KPI de faturamento
  try{
    const r = await fetch(`${API_BASE}/procedures`,{headers:{Accept:'application/json'}});
    if(!r.ok) return [];
    return r.json();
  }catch{ return []; }
}
async function apiPost(path, payload){
  const r = await fetch(`${API_BASE}${path}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(data?.message||'Erro');
  return data;
}

/* ========= STATE ========= */
let gDay=null, gFilter='all', gProcedures=[], gProcByName={};

/* ========= RENDER ========= */
function rowActions(ev, date){
  const wa=toWA(ev.phone||'');
  const waHref= wa? `https://wa.me/${wa}?text=${encodeURIComponent(
    `Olá ${ev.patientName||''}! Lembramos sua consulta ${ev.procedure?`de ${ev.procedure} `:''}em ${CLINIC} em ${fmtBR(date)} às ${ev.start}.`
  )}` : '#';
  const common = `data-id="${ev.id||''}" data-date="${date}" data-time="${ev.start||''}"`;
  return `
    <a class="btn-ic" ${wa?`href="${waHref}" target="_blank"`:'disabled'} title="WhatsApp">🟢</a>
    <button class="btn-ic" data-act="confirm" ${common} title="Confirmar">✅</button>
    <button class="btn-ic" data-act="checkin" ${common} title="Check-in">⏱</button>
    <button class="btn-ic" data-act="finish" ${common} title="Concluir">✔</button>
    <button class="btn-ic" data-act="noshow" ${common} title="Falta">🚫</button>
    <button class="btn-ic" data-act="reag" ${common} title="Reagendar">↔</button>
  `;
}

function renderTable(){
  const tb=document.getElementById('grid-body'); tb.innerHTML='';
  const start=gDay?.officeHours?.start||'08:00', end=gDay?.officeHours?.end||'19:00', step=gDay?.intervalMinutes||60;
  const slots=rangeSlots(start,end,step); const evByStart={}; (gDay?.events||[]).forEach(e=>{ if(e.start) evByStart[e.start]=e; });

  slots.forEach(h=>{
    const ev=evByStart[h];
    if(!ev){
      if(gFilter==='all'){
        tb.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${h}</td><td class="text-muted">—</td><td class="text-muted">—</td>
            <td>${statusBadge('livre')}</td><td>—</td><td>—</td>
            <td>
              <a href="book.html" class="btn-ic" title="Agendar">➕</a>
              <button class="btn-ic" data-act="block" data-date="${gDay.date}" data-time="${h}">🚧</button>
            </td>
          </tr>
        `);
      }
      return;
    }

    const s=(ev.status||'').toLowerCase();
    const sKey=s.includes('confirm')?'confirmado':(s.includes('cancel')?'cancelado':(s.includes('check-in')?'confirmado':'pendente'));
    if(gFilter!=='all' && gFilter!==sKey) return;
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${ev.start}</td>
        <td>${ev.patientName||'-'}</td>
        <td>${ev.procedure||'-'}</td>
        <td>${statusBadge(ev.status)}</td>
        <td>${ev.dentist||'—'}</td>
        <td>${ev.room||'—'}</td>
        <td>${rowActions(ev,gDay.date)}</td>
      </tr>
    `);
  });
}

function computeKPIs(){
  const ev=gDay?.events||[], step=gDay?.intervalMinutes||60;
  const k={total:0,conf:0,pend:0,canc:0,bookedMin:0,openMin:0,rev:0};
  const [sh,sm]=(gDay?.officeHours?.start||'08:00').split(':').map(Number);
  const [eh,em]=(gDay?.officeHours?.end||'19:00').split(':').map(Number);
  k.openMin=(eh*60+em)-(sh*60+sm);

  ev.forEach(e=>{
    k.total++;
    const s=(e.status||'').toLowerCase();
    if(s.includes('cancel')) k.canc++;
    else if(s.includes('confirm')||s.includes('check-in')||s.includes('concluded')) k.conf++;
    else k.pend++;

    const dur=Number(e.durationMin||step);
    if(!s.includes('cancel')) k.bookedMin+=dur;

    const price = gProcByName[(e.procedure||'').trim()]?.price || 0;
    if(!s.includes('cancel')) k.rev += price;
  });

  document.getElementById('kpi-total').textContent=k.total;
  document.getElementById('kpi-conf').textContent=k.conf;
  document.getElementById('kpi-pend').textContent=k.pend;
  document.getElementById('kpi-canc').textContent=k.canc;
  document.getElementById('kpi-occ').textContent = Math.round(100*(k.bookedMin/Math.max(1,k.openMin)));
  document.getElementById('kpi-hours').textContent = `${(k.bookedMin/60).toFixed(1)}h / ${(k.openMin/60).toFixed(1)}h`;
  document.getElementById('kpi-rev').textContent = k.rev.toLocaleString('pt-BR',{minimumFractionDigits:2});
}

async function loadDay(){
  const ds=document.getElementById('flt-date').value || ymdToday();
  document.getElementById('day-title').textContent=`${fmtBR(ds)} • ${TZ.replace('_',' ')}`;
  document.getElementById('grid-body').innerHTML='<tr><td colspan="7">Carregando…</td></tr>';
  try{
    gDay=await fetchDay(ds);
    document.getElementById('day-intv').textContent=`Intervalo de ${gDay?.intervalMinutes||60} min`;
    renderTable(); computeKPIs(); loadWaitlist();
  }catch(e){
    document.getElementById('grid-body').innerHTML=`<tr><td colspan="7" class="text-danger">${e.message}</td></tr>`;
  }
}

async function loadProceduresIndex(){
  gProcedures = await fetchProcedures();
  gProcByName = Object.fromEntries((gProcedures||[]).map(p=>[String(p.name||'').trim(), p]));
}

/* ========= WAITLIST ========= */
async function loadWaitlist(){
  const ds=document.getElementById('flt-date').value || ymdToday();
  const ul=document.getElementById('wl-list'); ul.innerHTML='Carregando…';
  try{
    const r=await fetch(`${API_BASE}/waitlist/list?date=${encodeURIComponent(ds)}`); 
    const items= await r.json().catch(()=>[]);
    if(!items.length){ ul.innerHTML='<li class="muted">Sem itens</li>'; return; }
    ul.innerHTML='';
    items.forEach(w=>{
      const wa=toWA(w.phone||''); const assignAttrs=`data-name="${w.name||''}" data-proc="${w.procedure||''}" data-phone="${w.phone||''}"`;
      ul.insertAdjacentHTML('beforeend',`
        <li class="py-1 border-bottom">
          <div class="d-flex justify-content-between">
            <div><strong>${w.name||'-'}</strong> <span class="muted">(${w.procedure||'—'})</span></div>
            <div>
              <button class="btn btn-sm btn-outline-secondary pill" data-act="assign" ${assignAttrs}>Agendar</button>
              ${wa?`<a class="btn btn-sm btn-outline-secondary pill" target="_blank" href="https://wa.me/${wa}?text=${encodeURIComponent('Temos uma vaga hoje, gostaria?')}">WA</a>`:''}
            </div>
          </div>
        </li>
      `);
    });
  }catch{ ul.innerHTML='<li class="text-danger">Falha ao carregar</li>'; }
}

document.getElementById('wl-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload={ name:wl-name.value.trim(), phone:wl-phone.value.trim(), procedure:wl-proc.value.trim(), notes:wl-notes.value.trim(), tz:TZ, date:flt-date.value };
  try{ await apiPost('/waitlist/add', payload); wl-form.reset(); loadWaitlist(); }catch(err){ alert(err.message); }
});

/* ========= ACTIONS ========= */
document.addEventListener('click', async (ev)=>{
  const b = ev.target.closest('[data-act]'); if(!b) return;
  const act=b.dataset.act, id=b.dataset.id, date=b.dataset.date, time=b.dataset.time;

  if(act==='block'){ // bloqueio manual
    try{
      await apiPost('/appointments/block',{date,time,reason:'Bloqueio manual',durationMin:gDay.intervalMinutes||60,tz:TZ});
      await loadDay();
    }catch(err){ alert(err.message); }
    return;
  }

  if(act==='reag'){ // abrir modal
    $('#md-reag').modal('show');
    md-id.value=id; md-date.value=date; md-time.value=''; md-slots.innerHTML='Carregando…'; md-feedback.textContent='';
    try{
      const bag=await fetchAvailability(date);
      const slots=rangeSlots(bag?.officeHours?.start||'08:00', bag?.officeHours?.end||'19:00', bag?.intervalMinutes||60);
      const busy=(bag?.busy||[]);
      const toMin=t=>{const [h,m]=t.split(':').map(Number);return h*60+m};
      const free=slots.filter(s=>!busy.some(([a,b])=>toMin(s)>=toMin(a)&&toMin(s)<toMin(b)));
      md-slots.innerHTML = free.map(t=>`<button class="btn btn-sm btn-outline-secondary pill m-1" data-sel="${t}">${t}</button>`).join('') || '<div class="muted">Sem horários disponíveis</div>';
    }catch{ md-slots.innerHTML='<div class="text-danger">Erro ao carregar disponibilidade.</div>'; }
    return;
  }

  if(b.dataset.sel){ // selecionar slot do modal
    md-time.value=b.dataset.sel;
    document.querySelectorAll('#md-slots [data-sel]').forEach(x=>x.classList.remove('btn-primary')); 
    b.classList.add('btn-primary');
    return;
  }

  if(['confirm','checkin','finish','noshow'].includes(act)){ // status
    const statusMap={confirm:'confirmed',checkin:'check-in',finish:'concluded',noshow:'cancelled'};
    try{
      await apiPost('/appointments/updateStatus',{id,date,time,status:statusMap[act],tz:TZ});
      await loadDay();
    }catch(err){ alert(err.message); }
    return;
  }

  if(act==='assign'){ // atribuir espera à primeira vaga (simples: abre modal já com a data atual)
    $('#md-reag').modal('show');
    md-id.value=''; md-date.value=flt-date.value;
    md-slots.innerHTML='Carregando…'; md-feedback.textContent=`Agendando ${b.dataset.name} • ${b.dataset.proc||''}`;
    try{
      const bag=await fetchAvailability(md-date.value);
      const slots=rangeSlots(bag?.officeHours?.start||'08:00', bag?.officeHours?.end||'19:00', bag?.intervalMinutes||60);
      const busy=(bag?.busy||[]); const toMin=t=>{const [h,m]=t.split(':').map(Number);return h*60+m};
      const free=slots.filter(s=>!busy.some(([a,b])=>toMin(s)>=toMin(a)&&toMin(s)<toMin(b)));
      md-slots.innerHTML = free.map(t=>`<button class="btn btn-sm btn-outline-secondary pill m-1" data-sel="${t}">${t}</button>`).join('') || '<div class="muted">Sem horários</div>';
      md-feedback.dataset.wl = JSON.stringify({name:b.dataset.name, phone:b.dataset.phone, procedure:b.dataset.proc});
    }catch{ md-slots.innerHTML='<div class="text-danger">Erro ao carregar disponibilidade.</div>'; }
    return;
  }
});

/* salvar reagendamento / novo */
document.getElementById('md-save').addEventListener('click', async ()=>{
  const id=md-id.value, date=md-date.value, time=md-time.value;
  if(!time){ md-feedback.innerHTML='<div class="text-danger">Selecione um horário.</div>'; return; }
  try{
    const extra = md-feedback.dataset.wl ? JSON.parse(md-feedback.dataset.wl) : null;
    await apiPost('/appointments/reschedule',{ id,date,time,tz:TZ, waitlistAssign:extra });
    md-feedback.innerHTML='<div class="text-success">Salvo!</div>';
    setTimeout(()=>{$('#md-reag').modal('hide'); md-feedback.innerHTML=''; md-feedback.dataset.wl='';}, 400);
    await loadDay();
  }catch(err){ md-feedback.innerHTML=`<div class="text-danger">${err.message}</div>`; }
});

/* ========= MASS ========= */
document.getElementById('act-confirm-pending').addEventListener('click', async ()=>{
  const pend=(gDay?.events||[]).filter(e=>!(String(e.status||'').toLowerCase().includes('confirm') || String(e.status||'').toLowerCase().includes('cancel')));
  for(const e of pend){
    try{ await apiPost('/appointments/updateStatus',{id:e.id,date:gDay.date,time:e.start,status:'confirmed',tz:TZ}); }catch{}
  }
  await loadDay();
});
document.getElementById('act-send-reminders').addEventListener('click', ()=>{
  (gDay?.events||[]).forEach(e=>{
    const wa=toWA(e.phone||''); if(!wa || !e.start) return;
    const msg=`Olá ${e.patientName||''}! Lembramos sua consulta ${e.procedure?`de ${e.procedure} `:''}em ${CLINIC} em ${fmtBR(gDay.date)} às ${e.start}.`;
    window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`,'_blank');
  });
});
document.getElementById('act-lunch').addEventListener('click', async ()=>{
  try{ await apiPost('/appointments/block',{date:gDay.date,time:'12:00',durationMin:gDay?.intervalMinutes||60,reason:'Almoço',tz:TZ}); await loadDay(); }
  catch(err){ alert(err.message); }
});
document.getElementById('act-print').addEventListener('click',()=>window.print());

/* ========= NAV / FILTER ========= */
document.getElementById('btn-prev').addEventListener('click',()=>shift(-1));
document.getElementById('btn-next').addEventListener('click',()=>shift(+1));
document.getElementById('btn-today').addEventListener('click',()=>{flt-date.value=ymdToday();loadDay();});
function shift(dlt){ const d=new Date(flt-date.value||ymdToday()); d.setDate(d.getDate()+dlt); flt-date.value=`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; loadDay(); }
document.getElementById('flt-date').addEventListener('change',loadDay);
document.querySelectorAll('.legend .chip').forEach(ch=>ch.addEventListener('click',()=>{
  document.querySelectorAll('.legend .chip').forEach(x=>x.classList.remove('active'));
  ch.classList.add('active'); gFilter=ch.dataset.filter||'all'; renderTable();
}));

/* ========= TASKS (local) ========= */
const TASKS_KEY='dent_tasks';
function loadTasks(){ const ul=document.getElementById('tasks'); const arr=JSON.parse(localStorage.getItem(TASKS_KEY)||'[]'); ul.innerHTML=''; arr.forEach((t,i)=>ul.insertAdjacentHTML('beforeend',`
  <li class="d-flex align-items-center justify-content-between py-1 border-bottom">
    <div><input type="checkbox" ${t.done?'checked':''} data-tk="${i}" class="mr-2"/> ${t.text}</div>
    <button class="btn btn-sm btn-outline-secondary pill" data-rm="${i}">Remover</button>
  </li>`));
}
document.getElementById('task-add').addEventListener('click',()=>{
  const text=prompt('Nova tarefa'); if(!text) return;
  const arr=JSON.parse(localStorage.getItem(TASKS_KEY)||'[]'); arr.push({text,done:false}); localStorage.setItem(TASKS_KEY,JSON.stringify(arr)); loadTasks();
});
document.addEventListener('change',(e)=>{ if(e.target.matches('[data-tk]')){ const idx=+e.target.dataset.tk; const arr=JSON.parse(localStorage.getItem(TASKS_KEY)||'[]'); arr[idx].done=e.target.checked; localStorage.setItem(TASKS_KEY,JSON.stringify(arr)); }});
document.addEventListener('click',(e)=>{ if(e.target.matches('[data-rm]')){ const idx=+e.target.dataset.rm; const arr=JSON.parse(localStorage.getItem(TASKS_KEY)||'[]'); arr.splice(idx,1); localStorage.setItem(TASKS_KEY,JSON.stringify(arr)); loadTasks(); }});

/* ========= SHORTCUTS ========= */
document.addEventListener('keydown',(e)=>{
  if(e.altKey||e.ctrlKey||e.metaKey) return;
  if(e.key==='n') window.location='book.html';
  if(e.key==='t') {flt-date.value=ymdToday(); loadDay();}
  if(e.key==='ArrowLeft') shift(-1);
  if(e.key==='ArrowRight') shift(+1);
});

/* ========= BOOT ========= */
(async function(){
  flt-date.value=ymdToday();
  await loadProceduresIndex();
  loadTasks();
  loadDay();
})();
</script>
</body>
</html>
