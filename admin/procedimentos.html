<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CRM Odonto – Procedimentos</title>
  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="css/crm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="js/sidebar.js" defer></script>
  <style>
    .pager small{color:var(--muted)}
    .pager .page-btn{min-width:34px}
    .table td, .table th{vertical-align: middle;}
  </style>
</head>
<body data-page="procedimentos">

<div class="crm-app">
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <!-- org_id que o n8n/Supabase usa -->
    <input type="hidden" id="org-id" value="6f8b8f6b-1e34-4d3f-9bcd-9b0acb5f0abc"/>

    <nav class="crm-nav">
      <a href="inicio.html" data-nav="inicio"><i class="fa-solid fa-grid-2"></i> Início</a>
      <a href="agenda.html" data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html" data-nav="pacientes"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html" data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html" data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <div class="crm-overlay" id="crm-overlay"></div>

  <main class="crm-main">
    <button class="crm-burger" id="btn-sidebar" aria-label="Abrir menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <section class="crm-hero">
      <h1 class="text-center mb-1">Procedimentos</h1>

      <div class="crm-search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="proc-q" placeholder="Buscar por nome, código, duração..." />
        <button id="proc-clear" class="btn btn-sm btn-outline-secondary btn-pill">Limpar</button>

        <div class="ml-auto d-flex align-items-center" style="gap:8px;">
          <button id="proc-reload" class="btn btn-sm btn-outline-secondary btn-pill">
            <i class="fa-solid fa-rotate"></i> Recarregar
          </button>
          <a href="#" id="btn-new-proc" class="btn btn-sm btn-primary btn-pill" data-toggle="modal" data-target="#md-proc">
            <i class="fa-solid fa-tooth mr-1"></i> Novo procedimento
          </a>
        </div>
      </div>
    </section>

    <section class="crm-content">
      <div class="crm-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="pager">
            <small id="pager-info">—</small>
          </div>
          <div class="d-flex align-items-center" style="gap:8px;">
            <small class="mr-1 muted">Por página</small>
            <select id="page-size" class="form-control form-control-sm" style="width:90px">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
            <div id="pager-buttons" class="ml-2"></div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
            <tr><th>Nome</th><th>Duração</th><th>Preço</th><th>Código</th><th class="text-right">Ações</th></tr>
            </thead>
            <tbody id="proc-tbody">
            <tr><td colspan="5" class="text-center text-muted">Carregando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL: Novo procedimento -->
<div class="modal fade" id="md-proc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="form-proc">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-tooth mr-2"></i>Novo procedimento</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nome</label>
          <input class="form-control" name="name" required>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>Duração</label>
            <select class="form-control" name="duration" required>
              <option value="30">30 min</option>
              <option value="45">45 min</option>
              <option value="60" selected>60 min</option>
              <option value="90">90 min</option>
              <option value="120">120 min</option>
            </select>
          </div>
          <div class="form-group col-md-4">
            <label>Preço</label>
            <input type="number" step="0.01" min="0" class="form-control" name="price" value="0.00" required>
          </div>
          <div class="form-group col-md-4">
            <label>Código</label>
            <input class="form-control" name="code" placeholder="ex: PROS001">
          </div>
        </div>
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="proc-active" checked>
          <label class="custom-control-label" for="proc-active">Ativo</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal" type="button">Cancelar</button>
        <button class="btn btn-primary btn-pill" type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Sidebar mobile -->
<script>
(function () {
  const app = document.querySelector('.crm-app');
  const btn = document.getElementById('btn-sidebar');
  const overlay = document.getElementById('crm-overlay');
  function close(){ app.classList.remove('sidebar-open'); }
  function toggle(){ app.classList.toggle('sidebar-open'); }
  btn?.addEventListener('click', toggle);
  overlay?.addEventListener('click', close);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  document.querySelectorAll('.crm-nav a').forEach(a => a.addEventListener('click', close));
})();
</script>

<!-- Apontar o seu n8n -->
<script>
  window.CRM_API_BASE = 'https://primary-odonto.up.railway.app/webhook/odonto';
</script>

<script>
(function () {
  // ====== CONFIG & HELPERS ======
  const API_BASE = (window.CRM_API_BASE || '').replace(/\/+$/,'');
  const ORG_ID   = document.getElementById('org-id')?.value || null;

  const qs = (o)=>{ const p=new URLSearchParams(); Object.entries(o||{}).forEach(([k,v])=>{ if(v!==undefined&&v!==null&&v!=='') p.append(k,String(v));}); return p.toString()?('?'+p.toString()):''; }
  const toBRL = v => (Number(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  // aceita praticamente tudo que o n8n possa devolver
  function unwrap(data){
    try{
      if(Array.isArray(data)){
        if(data.length && data[0] && typeof data[0]==='object' && 'json' in data[0]) return data.map(x=>x.json);
        return data;
      }
      if(!data || typeof data!=='object') return [];
      const cand = data.items || data.data || data.result || data.records || data.rows || data.list;
      if(Array.isArray(cand)){
        if(cand.length && cand[0] && typeof cand[0]==='object' && 'json' in cand[0]) return cand.map(x=>x.json);
        return cand;
      }
      if(data.json && typeof data.json==='object') return [data.json];

      const anyArray = Object.values(data).find(v=>Array.isArray(v));
      if(anyArray) return anyArray;

      return [];
    }catch(e){ console.warn('unwrap falhou', e); return []; }
  }

  async function http(url, opts={}){
    console.log('[procedures] GET →', url);
    const res  = await fetch(url, { headers:{Accept:'application/json'}, cache:'no-store', ...opts });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ data = text; }
    console.log('[procedures] status:', res.status, 'payload:', data);
    if(!res.ok){
      const msg = (data && (data.message || data.error?.message)) || res.statusText || 'Erro';
      throw new Error(msg);
    }
    return data;
  }

  async function getProcedures(){
    if(!API_BASE) throw new Error('CRM_API_BASE não definido');
    const url = API_BASE + '/procedures' + qs({ org_id: ORG_ID });
    const data = await http(url);
    return unwrap(data);
  }

  async function postProcedure(payload){
    const url = API_BASE + '/procedures';
    console.log('[procedures] POST →', url, payload);
    const res = await fetch(url, {
      method:'POST',
      headers:{ 'Accept':'application/json', 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const txt = await res.text(); let data; try{ data=JSON.parse(txt);}catch{ data=txt; }
    console.log('[procedures] POST status:', res.status, data);
    if(!res.ok){
      const msg = (data && (data.message || data.error?.message)) || res.statusText || 'Erro ao salvar';
      throw new Error(msg);
    }
    return data;
  }

  // ====== ELEMENTOS ======
  const tbody      = document.getElementById('proc-tbody');
  const qInput     = document.getElementById('proc-q');
  const btnClear   = document.getElementById('proc-clear');
  const btnReload  = document.getElementById('proc-reload');
  const pagerInfo  = document.getElementById('pager-info');
  const pagerBtns  = document.getElementById('pager-buttons');
  const pageSizeEl = document.getElementById('page-size');
  const formProc   = document.getElementById('form-proc');

  // ====== STATE ======
  let all = [];
  let filtered = [];
  let page = 1;
  let pageSize = Number(pageSizeEl?.value || 25);

  // ====== RENDER ======
  function renderRows(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length===0){
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum procedimento encontrado</td></tr>';
      return;
    }
    rows.forEach(p=>{
      const dur = p.default_duration_min ?? p.duration ?? 60;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name || '-'}</td>
        <td>${dur} min</td>
        <td>${toBRL(p.price || 0)}</td>
        <td>${p.code || '-'}</td>
        <td class="text-right">
          <a href="#" class="btn btn-sm btn-outline-secondary btn-pill" data-id="${p.id||''}">Editar</a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function renderPager(total){
    if(!pagerInfo || !pagerBtns) return;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if(page > pages) page = pages;

    const startIdx = total? ((page-1)*pageSize+1) : 0;
    const endIdx   = total? Math.min(total, page*pageSize) : 0;
    pagerInfo.textContent = total ? `Exibindo ${startIdx}–${endIdx} de ${total}` : '—';

    pagerBtns.innerHTML = '';
    const addBtn = (label, disabled, cb)=>{
      const b = document.createElement('button');
      b.className = 'btn btn-sm btn-outline-secondary btn-pill page-btn';
      b.textContent = label;
      b.disabled = disabled;
      b.onclick = cb;
      pagerBtns.appendChild(b);
    };
    addBtn('«', page===1, ()=>{ page--; apply(); });

    const max = 5, half = Math.floor(max/2);
    let a = Math.max(1, page-half), b = Math.min(pages, a+max-1);
    a = Math.max(1, b-max+1);
    for(let i=a;i<=b;i++){
      const btt = document.createElement('button');
      btt.className = 'btn btn-sm btn-outline-secondary btn-pill page-btn';
      btt.textContent = i;
      if(i===page) btt.classList.add('active');
      btt.onclick = ()=>{ page=i; apply(); };
      pagerBtns.appendChild(btt);
    }
    addBtn('»', page===pages, ()=>{ page++; apply(); });
  }

  function apply(){
    const q = (qInput?.value || '').trim().toLowerCase();
    filtered = !q ? all : all.filter(p=>{
      const name=(p.name||'').toLowerCase();
      const code=(p.code||'').toLowerCase();
      const dur = String(p.default_duration_min ?? p.duration ?? '');
      return name.includes(q) || code.includes(q) || dur.includes(q);
    });

    const total = filtered.length;
    renderPager(total);

    const start = (page-1)*pageSize;
    renderRows(filtered.slice(start, start+pageSize));
  }

  async function load(){
    try{
      btnReload?.setAttribute('disabled','disabled');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando…</td></tr>';
      all = await getProcedures();   // <— pega do webhook
      page = 1;
      apply();
    }catch(err){
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${err.message || 'Erro ao carregar'}</td></tr>`;
      pagerInfo && (pagerInfo.textContent = '—');
      pagerBtns  && (pagerBtns.innerHTML  = '');
    }finally{
      btnReload?.removeAttribute('disabled');
    }
  }

  // ====== EVENTS ======
  qInput?.addEventListener('input', ()=>{ page=1; apply(); });
  btnClear?.addEventListener('click', ()=>{ if(qInput){ qInput.value=''; page=1; apply(); }});
  btnReload?.addEventListener('click', e=>{ e.preventDefault(); load(); });
  pageSizeEl?.addEventListener('change', ()=>{ pageSize = Number(pageSizeEl.value||25); page=1; apply(); });

  formProc?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.target;
    const payload = {
      org_id: ORG_ID,
      name: f.name.value.trim(),
      default_duration_min: Number(f.duration.value || 60),
      price: Number(f.price.value || 0),
      code: f.code.value.trim() || null,
      active: document.getElementById('proc-active')?.checked !== false
    };
    if(!payload.name){ alert('Informe o nome.'); return; }
    try{
      const btn = f.querySelector('[type="submit"]');
      btn.setAttribute('disabled','disabled');
      await postProcedure(payload);
      $('#md-proc').modal('hide');
      f.reset(); f.duration.value = '60';
      document.getElementById('proc-active').checked = true;
      await load();
    }catch(err){
      console.error(err);
      alert(err.message || 'Erro ao salvar');
    }finally{
      f.querySelector('[type="submit"]').removeAttribute('disabled');
    }
  });

  // kick-off
  load();
})();
</script>

<!-- Action Sheet: Atalhos do botão "Lista" -->
<div id="crm-menu-sheet" class="crm-action-sheet">
  <div class="sheet-header">Ir para</div>
  <a class="sheet-item" href="inicio.html"><i class="fa-solid fa-house"></i> Início</a>
  <a class="sheet-item" href="agenda.html"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
  <a class="sheet-item" href="pacientes.html"><i class="fa-regular fa-user"></i> Pacientes</a>
  <a class="sheet-item" href="orcamentos.html"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
  <a class="sheet-item" href="procedimentos.html"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
  <a class="sheet-item" href="procedimentos.html"><i class="fa-solid fa-notes-medical"></i> Documentos</a>
  <a class="sheet-item" href="configuracoes.html"><i class="fa-solid fa-gear"></i> Configurações</a>
</div>
<!-- BOTTOM BAR • DRIBBBLE-LIKE -->
<nav class="bb-dribbble" id="bbBar" aria-label="Navegação rápida">
  <!-- fundo com onda + notch -->
  <svg class="bb-bg" viewBox="0 0 1000 160" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <filter id="bbShadow" x="-20%" y="-50%" width="140%" height="200%">
        <feDropShadow dx="0" dy="14" stdDeviation="12" flood-color="rgba(15,23,42,.10)"/>
        <feDropShadow dx="0" dy="4"  stdDeviation="6"  flood-color="rgba(15,23,42,.08)"/>
      </filter>
    </defs>

    <!-- Path com notch (estado “em repouso”) -->
    <path id="bbPath" class="bb-path" filter="url(#bbShadow)"
      d="M18,26
         H360
         C420,26 440,6 500,6
         C560,6 580,26 640,26
         H982 Q994,26 994,38 V140
         Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z" />

    <!-- Morph da onda ao tocar -->
    <animate id="bbMorph" xlink:href="#bbPath" attributeName="d" dur="420ms" fill="freeze"
      values="
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H330 C400,26 440,-18 500,-18 C560,-18 600,26 670,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z
      " />
  </svg>

  <!-- Slots (mesma “placa”, sem borda) -->
  <button class="bb-tab" data-act="agenda" aria-label="Agenda">
    <i class="fa-regular fa-calendar-days"></i>
    <span>Agenda</span>
  </button>

  <button class="bb-fab" data-act="quick" aria-label="Ações rápidas">
    <i class="fa-solid fa-plus"></i>
  </button>

  <button class="bb-tab" data-act="menu" aria-label="Menu">
    <i class="fa-solid fa-list-ul"></i>
    <span>Menu</span>
  </button>
</nav>


<script>
(function () {
  const bar     = document.getElementById('crm-bottombar');
  const overlay = document.getElementById('crm-sheet-overlay');
  const quick   = document.getElementById('crm-quick-sheet');
  const menu    = document.getElementById('crm-menu-sheet');

  if (!bar) return;

  const openSheet = sheet => {
    closeSheets();
    overlay.classList.add('show');
    sheet.classList.add('show');
  };
  const closeSheets = () => {
    overlay.classList.remove('show');
    quick.classList.remove('show');
    menu.classList.remove('show');
  };

  // Navegação dos botões principais
  bar.addEventListener('click', (e) => {
    const act = e.target.closest('button')?.dataset?.act;
    if (!act) return;

    if (act === 'agenda') {
      window.location.href = 'agenda.html';
    } else if (act === 'menu') {
      openSheet(menu);
    } else if (act === 'quick') {
      openSheet(quick);
    }
  });

  // Fecha overlay
  overlay.addEventListener('click', closeSheets);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSheets(); });

  // Ações rápidas (+)
  quick.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-quick]');
    if(!btn) return;
    const what = btn.dataset.quick;

    const openModal = (id, fallbackUrl) => {
      if (window.$ && $(id).length) { $(id).modal('show'); }
      else window.location.href = fallbackUrl;
    };

    if (what === 'agendamento') {
      openModal('#md-agendamento','inicio.html'); // ou agenda.html, se preferir
    }
    if (what === 'paciente') {
      openModal('#md-paciente','inicio.html');
    }
    if (what === 'orcamento') {
      openModal('#md-orcamento','orcamentos.html');
    }
    if (what === 'procedimentos') {
      window.location.href = 'procedimentos.html';
    }
    closeSheets();
  });
})();
</script>

<script>
(function(){
  const API_BASE = (window.CRM_API_BASE || '').replace(/\/+$/,'');
  const UL = document.getElementById('upcoming-list');

  const qs = o => {
    const p = new URLSearchParams();
    Object.entries(o||{}).forEach(([k,v])=>{
      if(v!==undefined && v!==null && v!=='') p.append(k, String(v));
    });
    return p.toString() ? '?' + p.toString() : '';
  };

  function labelData(startISO, allDay){
    const d  = new Date(startISO);
    const n  = new Date();
    const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const n0 = new Date(n.getFullYear(), n.getMonth(), n.getDate());
    const diffDays = Math.round((d0 - n0)/86400000);

    const hhmm = allDay ? '' : ' ' + d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    if (diffDays === 0) return 'Hoje'    + hhmm;
    if (diffDays === 1) return 'Amanhã'  + hhmm;
    return d.toLocaleDateString('pt-BR', { weekday:'short' }) + hhmm; // ex: seg., ter., qua...
  }

  function render(items){
    UL.innerHTML = '';
    if(!items || !items.length){
      UL.innerHTML = '<li class="py-2 text-muted">Sem próximos agendamentos</li>';
      return;
    }
    items.forEach(ev=>{
      const when = labelData(ev.start, ev.allDay);
      const li = document.createElement('li');
      li.className = 'py-2 border-bottom';
      li.innerHTML = `
        <i class="fa-regular fa-clock mr-2" style="color:#10b981"></i>
        <strong>${when}</strong> – ${ev.title || '(sem título)'}
      `;
      UL.appendChild(li);
    });
  }

  async function loadUpcoming(){
    try{
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const url = API_BASE + '/calendar/upcoming' + qs({ days: 7, limit: 3, tz });
      const data = await CRMApi.getCalendarUpcoming({days:7, limit:3});
      const data = await res.json();
      const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
      render(items);
    }catch(err){
      console.error(err);
      UL.innerHTML = '<li class="py-2 text-danger">Erro ao carregar agenda</li>';
    }
  }

  loadUpcoming();
})();
</script>

<script>
(function(){
  const bar = document.getElementById('bbBar');
  if(!bar) return;

  const tabAgenda = bar.querySelector('.bb-tab[data-act="agenda"]');
  const tabMenu   = bar.querySelector('.bb-tab[data-act="menu"]');
  const fab       = bar.querySelector('.bb-fab');
  const morph     = document.getElementById('bbMorph');

  // seus sheets existentes
  const overlay = document.getElementById('crm-sheet-overlay');
  const quick   = document.getElementById('crm-quick-sheet');
  const menu    = document.getElementById('crm-menu-sheet');
  const openSheet = el => { overlay?.classList.add('show'); el?.classList.add('show'); };
  const closeSheets = () => { overlay?.classList.remove('show'); quick?.classList.remove('show'); menu?.classList.remove('show'); };
  overlay?.addEventListener('click', closeSheets);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSheets(); });

  function wave(){ try{ morph.beginElement(); }catch(e){} }
  function bounce(el){
    const i = el.querySelector('i'), s=el.querySelector('span');
    i?.classList.remove('bb-bounce'); s?.classList.remove('bb-bounce');
    void i?.offsetWidth; void s?.offsetWidth; // reflow
    i?.classList.add('bb-bounce'); s?.classList.add('bb-bounce');
  }
  function setActive(btn){
    [tabAgenda, tabMenu].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }

  tabAgenda.addEventListener('click', ()=>{
    setActive(tabAgenda); wave(); bounce(tabAgenda);
    setTimeout(()=> location.href='agenda.html', 120);
  });

  tabMenu.addEventListener('click', ()=>{
    setActive(tabMenu); wave(); bounce(tabMenu);
    openSheet(menu);
  });

  fab.addEventListener('click', ()=>{
    wave(); fab.classList.remove('bb-fab-pop'); void fab.offsetWidth; fab.classList.add('bb-fab-pop');
    openSheet(quick);
  });

  // estado inicial
  setActive(tabAgenda);
})();
</script>

</body>
</html>









