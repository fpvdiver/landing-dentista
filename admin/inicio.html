<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CRM Odonto – Início</title>
  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="css/crm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="js/sidebar.js" defer></script>
  <style>
    /* pequenos ajustes visuais deste arquivo */
    .btn-pill{border-radius:999px}
    .crm-quick .crm-chip{cursor:pointer}
    .modal-header.themed{background:linear-gradient(180deg,#e0f2fe 0%, #f5f3ff 100%);border-bottom:1px solid var(--ring)}
    .modal-header .modal-title{font-weight:800;letter-spacing:.2px}
    .form-section-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-weight:700;margin:8px 0 4px}
    .table-mini td,.table-mini th{padding:.55rem .6rem}
    .w-44{width:44px}
    .chip-inline{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--ring);border-radius:999px;background:#fff}
    /* multiselect de procedimentos (agendamento) */
    #ag-procs{min-height:120px}
    #ag-procs option{padding:6px}
    .hint{font-size:.8rem;color:var(--muted)}
  </style>
</head>
<body data-page="inicio">

<div class="crm-app">
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <!-- ID da organização -->
    <input type="hidden" id="org-id" value="6f8b8f6b-1e34-4d3f-9bcd-9b0acb5f0abc" />

    <nav class="crm-nav">
      <a href="inicio.html" data-nav="inicio" class="active"><i class="fa-solid fa-house"></i> Início</a>
      <a href="agenda.html" data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html" data-nav="pacientes"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html" data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html" data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="documentos.html" data-nav="campanhas"><i class="fa-solid fa-notes-medical"></i> Documentos</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <!-- overlay mobile -->
  <div class="crm-overlay" id="crm-overlay"></div>

  <main class="crm-main">
    <section class="crm-hero">
      <h1 class="text-center mb-1">O que você quer fazer hoje?</h1>
      <div class="tabs justify-content-center">
        <div class="pill active">Minha clínica</div>
        <div class="pill">Fluxos</div>
        <div class="pill">Agente IA</div>
      </div>
      <div class="crm-search">
        <i class="fa-solid fa-magnifying-glass" style="color:var(--muted)"></i>
        <input placeholder="Busque por paciente, agendamento, orçamento..." />
        <button class="btn btn-sm btn-outline-secondary btn-pill">Buscar</button>
      </div>
      <div class="search-hint">Dica: “@amanhã” ou “#implante”.</div>
      <div class="crm-quick container-fluid">
        <div class="crm-chip" data-open="#md-agendamento"><i class="fa-regular fa-calendar-plus"></i> Novo agendamento</div>
        <div class="crm-chip" data-open="#md-paciente"><i class="fa-regular fa-user"></i> Novo paciente</div>
        <div class="crm-chip" data-open="#md-orcamento"><i class="fa-regular fa-clipboard"></i> Novo orçamento</div>
        <div class="crm-chip" data-open="#md-procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</div>
      </div>
    </section>

    <section class="crm-content">
      <div class="row">
        <div class="col-lg-6 mb-3">
          <div class="crm-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="font-weight-bold">Próximos agendamentos</div>
              <a href="agenda.html" class="btn btn-sm btn-outline-secondary btn-pill">Ver agenda</a>
            </div>
            <ul class="list-unstyled mb-0" id="upcoming-list">
              <li class="py-2 text-muted">Carregando…</li>
            </ul>
          </div>
        </div>
        <div class="col-lg-6 mb-3">
          <div class="crm-card mb-3">
            <div class="d-flex justify-content-between">
              <div><div class="muted">Negociações</div><div class="h4 mb-0">192</div></div>
              <div><div class="muted">Contatos</div><div class="h4 mb-0">196</div></div>
              <div><div class="muted">Conversão</div><div class="h4 mb-0">28,1%</div></div>
              <div><div class="muted">Receita</div><div class="h4 mb-0">R$ 4.981,15</div></div>
            </div>
          </div>
          <div class="crm-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="font-weight-bold">Próximos agendamentos</div>
              <a href="agenda.html" class="btn btn-sm btn-outline-secondary btn-pill">Ver agenda</a>
            </div>
            <ul class="list-unstyled mb-0" id="upcoming-list-ghost">
              <li class="py-2 border-bottom"><i class="fa-regular fa-clock mr-2" style="color:#10b981"></i> Amanhã 10:00 – Profilaxia (Amanda)</li>
              <li class="py-2 border-bottom"><i class="fa-regular fa-clock mr-2" style="color:#10b981"></i> Amanhã 14:00 – Endodontia (Bruna)</li>
              <li class="py-2"><i class="fa-regular fa-clock mr-2" style="color:#10b981"></i> 3ªf 09:30 – Avaliação (Carlos)</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- ====== MODAIS ====== -->
<!-- md: NOVO AGENDAMENTO (multi-procedimento) -->
<div class="modal fade" id="md-agendamento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-regular fa-calendar-plus mr-2"></i>Novo agendamento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
      </div>

      <form id="form-agendamento">
        <div class="modal-body">
          <div class="form-section-title">Paciente</div>
          <div class="form-row">
            <div class="form-group col-md-8 position-relative">
              <label>Nome do paciente</label>
              <input id="ag-paciente" class="form-control" name="paciente"
                     placeholder="Digite para buscar ou cadastrar" autocomplete="off">
              <input type="hidden" name="patient_id" id="ag-paciente-id">
              <div id="ag-paciente-picked" class="paciente-selected d-none">
                Selecionado: <span class="sel-name"></span>
                <a id="ag-paciente-trocar">Trocar</a>
              </div>
            </div>
            <div class="form-group col-md-4 d-flex align-items-end">
              <button type="button" class="btn btn-outline-secondary btn-pill w-100" data-toggle="modal" data-target="#md-paciente">
                <i class="fa-regular fa-user mr-1"></i> Novo paciente
              </button>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Telefone (WhatsApp)</label>
              <input class="form-control" name="phone" placeholder="(11) 9 9999-9999">
            </div>
            <div class="form-group col-md-4">
              <label>E-mail</label>
              <input type="email" class="form-control" name="email" placeholder="email@exemplo.com">
            </div>
            <div class="form-group col-md-4">
              <label>Preferência de contato</label>
              <select class="form-control" name="channel">
                <option>WhatsApp</option><option>E-mail</option><option>Telefone</option>
              </select>
            </div>
          </div>

          <div class="form-section-title">Atendimento</div>
          <div class="form-row">
            <div class="form-group col-md-5">
              <label>Procedimentos (selecione 1 ou mais)</label>
              <select multiple class="form-control" name="procs" id="ag-procs" size="6"></select>
              <small class="hint">A duração sugerida soma as durações dos procedimentos selecionados.</small>
            </div>

            <div class="form-group col-md-3">
              <label>Data</label>
              <input type="date" class="form-control" name="date" id="ag-date" required>
            </div>

            <div class="form-group col-md-2">
              <label>Hora</label>
              <select class="form-control" name="time" id="ag-time" required>
                <option value="">Selecione a data…</option>
              </select>
            </div>

            <div class="form-group col-md-2">
              <label>Duração</label>
              <select class="form-control" name="dur" id="ag-dur">
                <option value="30">30 min</option>
                <option value="45">45 min</option>
                <option value="60" selected>1 h</option>
                <option value="90">1h30</option>
                <option value="120">2 h</option>
                <option value="150">2h30</option>
                <option value="180">3 h</option>
                <option value="210">3h30</option>
                <option value="240">4 h</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Clínica</label>
              <select class="form-control" name="clinic" id="ag-clinic">
                <option value="Principal" selected>Clínica principal</option>
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Dentista</label>
              <select class="form-control" name="doctor" id="ag-doctor">
                <option>Dra. Elen Nogata</option>
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Observações</label>
              <input class="form-control" name="notes" placeholder="Anote algo importante (opcional)">
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div>
              <span class="chip-inline"><input type="checkbox" class="mr-2" name="send_whats">WhatsApp</span>
              <span class="chip-inline ml-2"><input type="checkbox" class="mr-2" name="send_mail">E-mail</span>
              <span class="chip-inline ml-2"><input type="checkbox" class="mr-2" name="send_sms">SMS</span>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="ag-status" checked>
              <label class="custom-control-label" for="ag-status">Confirmado</label>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-outline-secondary btn-pill" type="button" id="agendar-salvar">Salvar</button>
          <button class="btn btn-primary btn-pill" type="submit" id="agendar-enviar">Salvar & Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- md: NOVO PACIENTE -->
<div class="modal fade" id="md-paciente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-regular fa-user mr-2"></i>Novo paciente</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <form id="form-paciente">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-8">
              <label>Nome completo</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="form-group col-md-4">
              <label>CPF (opcional)</label>
              <input class="form-control" name="cpf">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-3">
              <label>Nascimento</label>
              <input type="date" class="form-control" name="dob">
            </div>
            <div class="form-group col-md-3">
              <label>Sexo</label>
              <select class="form-control" name="gender">
                <option>Feminino</option><option>Masculino</option><option>Outro</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Telefone</label>
              <input class="form-control" name="phone" placeholder="(11) 9 9999-9999">
            </div>
            <div class="form-group col-md-3">
              <label>E-mail</label>
              <input type="email" class="form-control" name="email">
            </div>
          </div>

          <div class="form-section-title">Endereço</div>
          <div class="form-row">
            <div class="form-group col-md-3"><label>CEP</label><input class="form-control" name="cep"></div>
            <div class="form-group col-md-6"><label>Logradouro</label><input class="form-control" name="street"></div>
            <div class="form-group col-md-3"><label>Número</label><input class="form-control" name="number"></div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4"><label>Bairro</label><input class="form-control" name="district"></div>
            <div class="form-group col-md-5"><label>Cidade</label><input class="form-control" name="city"></div>
            <div class="form-group col-md-3"><label>UF</label><input class="form-control" name="uf" maxlength="2"></div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Como nos conheceu?</label>
              <select class="form-control" name="source">
                <option>Indicação</option><option>Instagram</option><option>Google</option><option>Outros</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label>Observações</label>
              <input class="form-control" name="notes" placeholder="Alergias, preferências...">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-pill" type="submit">Salvar paciente</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- md: NOVO ORÇAMENTO (itens carregam os mesmos procedimentos do agendamento) -->
<div class="modal fade" id="md-orcamento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-regular fa-clipboard mr-2"></i>Novo orçamento</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <form id="form-orc">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-5">
              <label>Paciente</label>
              <input list="dl-pacientes" class="form-control" name="paciente" required>
              <datalist id="dl-pacientes"></datalist>
            </div>
            <div class="form-group col-md-3">
              <label>Validade</label>
              <input type="date" class="form-control" name="validade">
            </div>
            <div class="form-group col-md-2">
              <label>Status</label>
              <select class="form-control" name="status">
                <option>Rascunho</option><option>Enviado</option><option>Aprovado</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <label>Canal</label>
              <select class="form-control" name="canal">
                <option>WhatsApp</option><option>E-mail</option><option>Imprimir</option>
              </select>
            </div>
          </div>

          <div class="form-section-title">Itens</div>
          <div class="table-responsive">
            <table class="table table-mini" id="orc-table">
              <thead>
                <tr>
                  <th style="min-width:260px">Procedimento</th>
                  <th class="w-44 text-center">Qtd</th>
                  <th style="width:140px">Valor unit. (R$)</th>
                  <th style="width:120px">Subtotal (R$)</th>
                  <th style="width:60px"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <button type="button" class="btn btn-outline-secondary btn-pill" id="orc-add">
            <i class="fa-solid fa-plus mr-1"></i> Adicionar item
          </button>

          <div class="row mt-3">
            <div class="col-lg-5">
              <label>Observações / Condições</label>
              <textarea class="form-control" name="obs" rows="4" placeholder="Formas de pagamento, prazos, observações clínicas..."></textarea>
            </div>
            <div class="col-lg-7">
              <div class="crm-card">
                <div class="d-flex justify-content-between">
                  <div class="muted">Subtotal</div><div id="orc-subtotal">R$ 0,00</div>
                </div>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <div class="muted">Desconto</div>
                  <div class="d-flex" style="gap:8px;">
                    <input type="number" class="form-control form-control-sm" id="orc-desc" style="width:120px" value="0">
                    <select class="form-control form-control-sm" id="orc-desc-type" style="width:90px">
                      <option value="abs">R$</option><option value="pct">%</option>
                    </select>
                  </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between h5 mb-0">
                  <div>Total</div><div id="orc-total">R$ 0,00</div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-outline-secondary btn-pill" type="button" id="orc-salvar">Salvar rascunho</button>
          <button class="btn btn-primary btn-pill" type="submit" id="orc-enviar">
            <i class="fa-brands fa-whatsapp mr-1"></i> Enviar/Finalizar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- md: PROCEDIMENTOS (lista visual) -->
<div class="modal fade" id="md-procedimentos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-solid fa-tooth mr-2"></i>Procedimentos</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-mini mb-3" id="proc-table">
            <thead>
              <tr><th>Nome</th><th>Duração</th><th>Preço (R$)</th><th>Código</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted">* Edição/criação está disponível na tela <strong>Procedimentos</strong>.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
<!-- ====== MODAIS – FIM ====== -->

<!-- libs -->
<script src="../js/jquery-3.4.1.min.js"></script>
<script src="../js/bootstrap.js"></script>

<!-- Config n8n -->
<script>
  window.CRM_API_BASE = 'https://primary-odonto.up.railway.app/webhook';
  window.TIMEZONE     = 'America/Sao_Paulo';
</script>
<script src="js/crm-api.js"></script>

<script>
/* ===== helpers gerais ===== */
function openModal(id){
  try{ $('.modal.show').modal('hide'); }catch(e){}
  document.querySelector('.crm-app')?.classList.remove('sidebar-open');
  setTimeout(()=>{ $(id).modal('show'); }, 120);
}
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.crm-chip[data-open]').forEach(ch=>{
    ch.addEventListener('click', ()=> openModal(ch.getAttribute('data-open')));
  });
});
</script>

<script>
/* ===== carregar procedimentos uma vez e abastecer: agendamento, orçamento e lista ===== */
let PROCS = []; // {id, name, default_dur_min, price, code}

async function loadProceduresOnce(orgId){
  try{
    const list = await CRMApi.getProcedures(orgId); // deve retornar array
    PROCS = (list||[]).map(p=>({
      id: p.id || p._id || null,
      name: p.name || p.title || p.nome,
      default_dur_min: Number(p.durationMin || p.duration || p.dur || 60),
      price: Number(p.price || p.preco || 0),
      code: p.code || p.codigo || ''
    })).filter(x=>x.name);
  }catch(e){
    // fallback básico
    PROCS = [
      {id:null,name:'Profilaxia',default_dur_min:60, price:150, code:'PRF'},
      {id:null,name:'Clareamento',default_dur_min:90, price:1200, code:'CLR'},
      {id:null,name:'Endodontia',default_dur_min:120, price:2900, code:'END'},
      {id:null,name:'Implante unitário',default_dur_min:120, price:4500, code:'IMP-1'}
    ];
  }
}

/* popular selects / tabelas a partir de PROCS */
function fillAgendamentoProcs(){
  const sel = document.getElementById('ag-procs');
  if(!sel) return;
  sel.innerHTML = PROCS.map(p =>
    `<option value="${p.name}" data-id="${p.id||''}" data-dur="${p.default_dur_min||60}" data-price="${p.price||0}">
      ${p.name} — ${p.default_dur_min||60} min${p.price?` • R$ ${p.price.toFixed(2)}`:''}
    </option>`).join('');
}
function fillProceduresTable(){
  const tb = document.querySelector('#proc-table tbody'); if(!tb) return;
  tb.innerHTML = PROCS.map(p => `
    <tr><td>${p.name}</td><td>${p.default_dur_min||60} min</td><td>${(p.price||0).toFixed(2)}</td><td>${p.code||'-'}</td></tr>
  `).join('');
}
function makeOrcRowHTML(){
  return `
    <tr>
      <td>
        <select class="form-control orc-proc">
          ${PROCS.map(p=>`<option value="${p.name}" data-id="${p.id||''}" data-price="${p.price||0}">${p.name}</option>`).join('')}
        </select>
      </td>
      <td class="text-center"><input type="number" class="form-control form-control-sm orc-qtd" value="1" min="1"></td>
      <td><input type="number" class="form-control form-control-sm orc-unit" step="0.01" value="${(PROCS[0]?.price||0).toFixed(2)}"></td>
      <td class="orc-sub text-right">0,00</td>
      <td class="text-right"><button class="btn btn-sm btn-outline-secondary btn-pill orc-del">&times;</button></td>
    </tr>`;
}
</script>

<script>
/* ===== lógica de AGENDAMENTO (slots e multi-procedimento) ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const ORG_ID = document.getElementById('org-id')?.value;

  await loadProceduresOnce(ORG_ID);
  fillAgendamentoProcs();
  fillProceduresTable();

  // preencher datalist de pacientes (light)
  try{
    const pts = await CRMApi.searchPatients(''); // se existir, retorna amostra
    const dl  = document.getElementById('dl-pacientes');
    if(dl && Array.isArray(pts)) dl.innerHTML = pts.slice(0,80).map(p=>`<option value="${p.full_name||p.name}">`).join('');
  }catch{}

  // autocomplete + seleção de paciente
  CRMApi.bindPatientAutocomplete({
    input: '#ag-paciente',
    onSelect(patient){ CRMApi.fillAgendamentoFromPatient(patient); },
    onCreateNew(query){
      openModal('#md-paciente');
      const form = document.getElementById('form-paciente');
      form?.querySelector('[name="name"]').focus();
      if (query) form.querySelector('[name="name"]').value = query;
    }
  });
  document.getElementById('ag-paciente-trocar')?.addEventListener('click', (e)=>{
    e.preventDefault(); CRMApi.clearAgendamentoPatient(); document.getElementById('ag-paciente').focus();
  });

  const f   = document.getElementById('form-agendamento');
  const dt  = document.getElementById('ag-date');
  const time= document.getElementById('ag-time');
  const dur = document.getElementById('ag-dur');
  const doc = document.getElementById('ag-doctor');
  const procsSel = document.getElementById('ag-procs');

  // sugere duração somando as seleções
  function suggestDurationFromProcs(){
    const total = Array.from(procsSel.selectedOptions).reduce((acc,o)=>acc + parseInt(o.dataset.dur||'60',10), 0);
    if(!total) return;
    // escolhe a opção de duração mais próxima acima ou igual
    const opts = Array.from(dur.options).map(o=>parseInt(o.value,10));
    const pick = opts.find(v=>v>=total) || opts[opts.length-1];
    dur.value = String(pick);
  }

  async function refreshTimes(){
    const date = dt.value; if (!date) return;
    time.innerHTML = '<option>Carregando…</option>';
    try{
      const bag   = await CRMApi.getAppointmentsByDay(date, doc?.value);
      const step  = Number(dur.value || 60);
      const slots = CRMApi.computeAvailableSlots(bag, step);
      time.innerHTML = slots.length
        ? slots.map(t=>`<option value="${t}">${t}</option>`).join('')
        : '<option value="">Sem horários disponíveis</option>';
    }catch(err){
      console.error(err);
      time.innerHTML = '<option value="">Erro ao carregar</option>';
    }
  }

  dt?.addEventListener('change', refreshTimes);
  dur?.addEventListener('change', refreshTimes);
  doc?.addEventListener('change', refreshTimes);
  procsSel?.addEventListener('change', ()=>{ suggestDurationFromProcs(); refreshTimes(); });

  // Envio
  async function submitAgendamento(sendNotifs){
    const selected = Array.from(procsSel.selectedOptions);
    const list = selected.map(o=>({ id:o.dataset.id||null, nome:o.value, durMin:parseInt(o.dataset.dur||'60',10), price:Number(o.dataset.price||0) }));
    const procStr = selected.map(o=>o.value).join(' + ');
    const firstId = selected.length===1 ? (selected[0].dataset.id||null) : null;

    const fAg = f;
    const payload = {
      paciente: fAg.paciente?.value || '',
      patient_id: fAg.patient_id?.value || null,
      phone:    fAg.phone?.value || null,
      email:    fAg.email?.value || null,
      canalPreferido: fAg.channel?.value || 'WhatsApp',
      procedimento: procStr,
      procedimentoId: firstId,
      procedimentos: list,                 // << múltiplos procedimentos
      data:      fAg.date?.value || null,
      hora:      fAg.time?.value || null,
      duracaoMin: Number(fAg.dur?.value || 60),
      dentista:  fAg.doctor?.value || '',
      obs:       fAg.notes?.value || '',
      confirmar: document.getElementById('ag-status')?.checked || false,
      enviar: sendNotifs ? {
        whatsapp: fAg.querySelector('[name="send_whats"]')?.checked || false,
        email:    fAg.querySelector('[name="send_mail"]')?.checked  || false,
        sms:      fAg.querySelector('[name="send_sms"]')?.checked   || false
      } : { whatsapp:false, email:false, sms:false }
    };
    const resp = await CRMApi.createAppointment(payload);
    $('#md-agendamento').modal('hide');
    alert(`Agendamento ${resp?.id ? '#'+resp.id : ''} salvo ✅`);
  }

  f?.addEventListener('submit', async (e)=>{ e.preventDefault(); try{ await submitAgendamento(true); }catch(err){ alert(err.message||'Falha ao salvar'); }});
  document.getElementById('agendar-salvar')?.addEventListener('click', async ()=>{ try{ await submitAgendamento(false); }catch(err){ alert(err.message||'Falha ao salvar'); }});
});
</script>

<script>
/* ===== ORÇAMENTO: usa os MESMOS procedimentos ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const tbody = document.querySelector('#orc-table tbody');
  const toBRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  function addRow(){
    tbody.insertAdjacentHTML('beforeend', makeOrcRowHTML());
    calc();
  }
  function calc(){
    let subtotal=0;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const qtd  = Number(tr.querySelector('.orc-qtd').value || 0);
      const unit = Number(tr.querySelector('.orc-unit').value || 0);
      const sub  = qtd*unit;
      tr.querySelector('.orc-sub').textContent = sub.toFixed(2).replace('.',',');
      subtotal += sub;
    });
    document.getElementById('orc-subtotal').textContent = toBRL(subtotal);
    const dval = Number(document.getElementById('orc-desc').value || 0);
    const dtype= document.getElementById('orc-desc-type').value;
    const desconto = (dtype==='pct') ? subtotal*(dval/100) : dval;
    const total = Math.max(0, subtotal - desconto);
    document.getElementById('orc-total').textContent = toBRL(total);
  }

  document.getElementById('orc-add')?.addEventListener('click', addRow);
  ['change','input'].forEach(ev=>{
    document.getElementById('orc-desc')?.addEventListener(ev, calc);
    document.getElementById('orc-desc-type')?.addEventListener(ev, calc);
  });
  tbody?.addEventListener('input', e=>{
    if(e.target.classList.contains('orc-proc')){
      const unit = e.target.closest('tr').querySelector('.orc-unit');
      unit.value = Number(e.target.selectedOptions[0].dataset.price || 0).toFixed(2);
    }
    calc();
  });
  tbody?.addEventListener('click', e=>{
    if(e.target.classList.contains('orc-del')){ e.preventDefault(); e.target.closest('tr').remove(); calc(); }
  });

  // cria 1ª linha
  if(tbody) addRow();

  // envio (mock)
  document.getElementById('form-orc')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    alert('Orçamento gerado ✅ (envio pelo canal selecionado)');
  });
});
</script>

<script>
/* ===== Próximos agendamentos (card da esquerda) ===== */
(function(){
  const UL = document.getElementById('upcoming-list');
  function labelData(startISO, allDay){
    const d  = new Date(startISO);
    const n  = new Date();
    const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const n0 = new Date(n.getFullYear(), n.getMonth(), n.getDate());
    const diff = Math.round((d0 - n0)/86400000);
    const hhmm = allDay ? '' : ' ' + d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    if(diff===0) return 'Hoje'+hhmm;
    if(diff===1) return 'Amanhã'+hhmm;
    return d.toLocaleDateString('pt-BR',{weekday:'short'})+hhmm;
  }
  async function loadUpcoming(){
    try{
      const items = await CRMApi.getCalendarUpcoming({days:7, limit:3}) || [];
      UL.innerHTML = '';
      if(!items.length){ UL.innerHTML = '<li class="py-2 text-muted">Sem próximos agendamentos</li>'; return; }
      items.forEach(ev=>{
        const li = document.createElement('li');
        li.className='py-2 border-bottom';
        li.innerHTML = `<i class="fa-regular fa-clock mr-2" style="color:#10b981"></i>
                        <strong>${labelData(ev.start, ev.allDay)}</strong> – ${ev.title || '(sem título)'}`;
        UL.appendChild(li);
      });
    }catch(e){
      console.error(e);
      UL.innerHTML = '<li class="py-2 text-danger">Erro ao carregar agenda</li>';
    }
  }
  loadUpcoming();
})();
</script>

<!-- Sidebar mobile -->
<script>
(function () {
  const app = document.querySelector('.crm-app');
  const btn = document.getElementById('btn-sidebar');
  const overlay = document.getElementById('crm-overlay');
  function close(){ app.classList.remove('sidebar-open'); }
  function toggle(){ app.classList.toggle('sidebar-open'); }
  btn?.addEventListener('click', toggle);
  overlay?.addEventListener('click', close);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
  document.querySelectorAll('.crm-nav a').forEach(a => { a.addEventListener('click', close); });
})();
</script>

<!-- Overlay + Bottom bar -->
<div id="crm-sheet-overlay" class="crm-sheet-overlay"></div>
<div id="crm-quick-sheet" class="crm-action-sheet">
  <div class="sheet-header">Ações rápidas</div>
  <button class="sheet-item" data-quick="agendamento"><i class="fa-regular fa-calendar-plus"></i> Novo agendamento</button>
  <button class="sheet-item" data-quick="paciente"><i class="fa-regular fa-user"></i> Novo paciente</button>
  <button class="sheet-item" data-quick="orcamento"><i class="fa-regular fa-clipboard"></i> Novo orçamento</button>
  <button class="sheet-item" data-quick="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</button>
</div>
<div id="crm-menu-sheet" class="crm-action-sheet">
  <div class="sheet-header">Ir para</div>
  <a class="sheet-item" href="inicio.html"><i class="fa-solid fa-house"></i> Início</a>
  <a class="sheet-item" href="agenda.html"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
  <a class="sheet-item" href="pacientes.html"><i class="fa-regular fa-user"></i> Pacientes</a>
  <a class="sheet-item" href="orcamentos.html"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
  <a class="sheet-item" href="procedimentos.html"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
  <a class="sheet-item" href="configuracoes.html"><i class="fa-solid fa-gear"></i> Configurações</a>
</div>

<nav class="bb-dribbble" id="bbBar" aria-label="Navegação rápida">
  <svg class="bb-bg" viewBox="0 0 1000 160" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <filter id="bbShadow" x="-20%" y="-50%" width="140%" height="200%">
        <feDropShadow dx="0" dy="14" stdDeviation="12" flood-color="rgba(15,23,42,.10)"/>
        <feDropShadow dx="0" dy="4"  stdDeviation="6"  flood-color="rgba(15,23,42,.08)"/>
      </filter>
    </defs>
    <path id="bbPath" class="bb-path" filter="url(#bbShadow)"
      d="M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z" />
    <animate id="bbMorph" xlink:href="#bbPath" attributeName="d" dur="420ms" fill="freeze"
      values="M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
              M18,26 H330 C400,26 440,-18 500,-18 C560,-18 600,26 670,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
              M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z" />
  </svg>

  <button class="bb-tab" data-act="agenda" aria-label="Agenda">
    <i class="fa-regular fa-calendar-days"></i><span>Agenda</span>
  </button>
  <button class="bb-fab" data-act="quick" aria-label="Ações rápidas"><i class="fa-solid fa-plus"></i></button>
  <button class="bb-tab" data-act="menu" aria-label="Menu">
    <i class="fa-solid fa-list-ul"></i><span>Menu</span>
  </button>
</nav>

<script>
/* bottom bar + sheets */
(function(){
  const bar=document.getElementById('bbBar'); if(!bar) return;
  const tabAgenda=bar.querySelector('.bb-tab[data-act="agenda"]');
  const tabMenu  =bar.querySelector('.bb-tab[data-act="menu"]');
  const fab      =bar.querySelector('.bb-fab');
  const morph    =document.getElementById('bbMorph');
  const overlay  =document.getElementById('crm-sheet-overlay');
  const quick    =document.getElementById('crm-quick-sheet');
  const menu     =document.getElementById('crm-menu-sheet');
  const openSheet=el=>{ overlay.classList.add('show'); el.classList.add('show'); };
  const closeAll =()=>{ overlay.classList.remove('show'); quick.classList.remove('show'); menu.classList.remove('show'); };
  overlay.addEventListener('click', closeAll);
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeAll(); });
  function wave(){ try{morph.beginElement();}catch{} }
  function setActive(btn){ [tabAgenda,tabMenu].forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }

  tabAgenda.addEventListener('click', ()=>{ setActive(tabAgenda); wave(); setTimeout(()=>location.href='agenda.html', 120); });
  tabMenu.addEventListener('click', ()=>{ setActive(tabMenu); wave(); openSheet(menu); });
  fab.addEventListener('click', ()=>{ wave(); openSheet(quick); });
  setActive(tabAgenda);
})();
</script>

</body>
</html>
