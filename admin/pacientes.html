<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Odonto – Pacientes</title>

  <link rel="stylesheet" href="../css/bootstrap.css" />
  <link rel="stylesheet" href="css/crm.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Sidebar (mesmo arquivo usado nas demais páginas) -->
  <script src="js/sidebar.js" defer></script>

  <style>
    .table td,.table th{ vertical-align: middle; }
    .empty-hint{ color: var(--muted); padding: 24px 8px; text-align:center; }
  </style>
</head>
<body data-page="pacientes">
<div class="crm-app">
  <!-- SIDEBAR -->
  <aside class="crm-sidebar" id="crm-sidebar">
    <div class="crm-brand">
      <span class="logo"></span>
      <div>
        <div style="font-weight:800; font-size:18px;">Clínica</div>
        <div style="color:var(--muted); font-size:12px;">Elen Nogata</div>
      </div>
    </div>

    <nav class="crm-nav">
      <a href="inicio.html" data-nav="inicio"><i class="fa-solid fa-grid-2"></i> Início</a>
      <a href="agenda.html" data-nav="agenda"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
      <a href="pacientes.html" data-nav="pacientes" class="active"><i class="fa-regular fa-user"></i> Pacientes</a>
      <a href="orcamentos.html" data-nav="orcamentos"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
      <a href="procedimentos.html" data-nav="procedimentos"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
      <a href="campanhas.html" data-nav="campanhas"><i class="fa-regular fa-paper-plane"></i> Campanhas</a>
      <a href="documentos.html" data-nav="campanhas"><i class="fa-solid fa-notes-medical"></i> Documentos</a>
      <a href="configuracoes.html" data-nav="configuracoes"><i class="fa-solid fa-gear"></i> Configurações</a>
    </nav>

    <div class="crm-footer">
      <div>Conectado como <strong>admin@clinica</strong></div>
      <div>v0.1</div>
    </div>
  </aside>

  <!-- overlay mobile -->
  <div class="crm-overlay" id="crm-overlay"></div>

  <!-- MAIN -->
  <main class="crm-main">
    <!-- Burger (mobile) -->
    <button class="crm-burger" id="btn-sidebar" aria-label="Abrir menu">
      <i class="fa-solid fa-bars"></i>
    </button>

    <!-- HERO -->
    <section class="crm-hero">
      <h1 class="text-center mb-1">Pacientes</h1>
      <div class="crm-search" style="max-width:860px">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="pac-busca" placeholder="Buscar por nome, telefone, e-mail..." />
        <button id="btn-buscar" class="btn btn-sm btn-outline-secondary btn-pill">Buscar</button>
        <a href="javascript:void(0)" id="btn-novo" class="btn btn-sm btn-primary btn-pill ml-auto">
          <i class="fa-regular fa-user mr-1"></i> Novo paciente
        </a>
      </div>
    </section>

    <!-- CONTEÚDO -->
    <section class="crm-content">
      <div class="crm-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="muted">Listando <span id="pac-count">0</span> pacientes</div>
          <div>
            <button id="p-prev" class="btn btn-sm btn-outline-secondary btn-pill mr-1" disabled>Anterior</button>
            <button id="p-next" class="btn btn-sm btn-outline-secondary btn-pill" disabled>Próximo</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>Nome</th><th>Telefone</th><th>E-mail</th><th>Última visita</th><th class="text-right">Ações</th>
              </tr>
            </thead>
            <tbody id="pac-tbody">
              <tr><td colspan="5" class="empty-hint">Carregando…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL: NOVO AGENDAMENTO -->
<div class="modal fade" id="md-agendamento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-regular fa-calendar-plus mr-2"></i>Novo agendamento</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>

      <form id="form-agendamento">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Paciente</label>
              <input class="form-control" name="paciente" required>
            </div>
            <div class="form-group col-md-3">
              <label>Telefone</label>
              <input class="form-control" name="phone" placeholder="(11) 9 9999-9999">
            </div>
            <div class="form-group col-md-3">
              <label>E-mail</label>
              <input type="email" class="form-control" name="email">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Procedimento</label>
              <select class="form-control" name="proc" id="ag-proc"></select>
            </div>
            <div class="form-group col-md-3">
              <label>Data</label>
              <input type="date" class="form-control" name="date" required>
            </div>
            <div class="form-group col-md-2">
              <label>Hora</label>
              <input type="time" class="form-control" name="time" step="1800" required>
            </div>
            <div class="form-group col-md-3">
              <label>Duração</label>
              <select class="form-control" name="dur" id="ag-dur">
                <option>30 min</option><option>45 min</option><option selected>60 min</option><option>90 min</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label>Dentista</label>
              <select class="form-control" name="doctor">
                <option>Dra. Elen Nogata</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label>Observações</label>
              <input class="form-control" name="notes" placeholder="Observações (opcional)">
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div>
              <label class="mr-2"><input type="checkbox" name="send_whats"> WhatsApp</label>
              <label class="mr-2"><input type="checkbox" name="send_mail"> E-mail</label>
              <label class="mr-2"><input type="checkbox" name="send_sms"> SMS</label>
            </div>
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="ag-status" checked>
              <label class="custom-control-label" for="ag-status">Confirmado</label>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-pill" type="submit">Salvar & Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- MODAL: NOVO PACIENTE -->
<div class="modal fade" id="md-paciente" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header themed">
        <h5 class="modal-title"><i class="fa-regular fa-user mr-2"></i>Novo paciente</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span>&times;</span></button>
      </div>
      <form id="form-paciente">
        <div class="modal-body">
          <input type="hidden" id="org-id" value="00000000-0000-0000-0000-000000000000" />

          <div class="form-row">
            <div class="form-group col-md-8">
              <label>Nome completo</label>
              <input class="form-control" name="name" required />
            </div>
            <div class="form-group col-md-4">
              <label>CPF (opcional)</label>
              <input class="form-control" name="cpf" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-3">
              <label>Nascimento</label>
              <input type="date" class="form-control" name="dob" />
            </div>
            <div class="form-group col-md-3">
              <label>Sexo</label>
              <select class="form-control" name="gender">
                <option value="">—</option>
                <option>Feminino</option><option>Masculino</option><option>Outro</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Telefone</label>
              <input class="form-control" name="phone" placeholder="(11) 9 9999-9999" />
            </div>
            <div class="form-group col-md-3">
              <label>E-mail</label>
              <input type="email" class="form-control" name="email" />
            </div>
          </div>

          <div class="form-section-title">Endereço</div>
          <div class="form-row">
            <div class="form-group col-md-3"><label>CEP</label><input class="form-control" name="cep" /></div>
            <div class="form-group col-md-6"><label>Logradouro</label><input class="form-control" name="street" /></div>
            <div class="form-group col-md-3"><label>Número</label><input class="form-control" name="number" /></div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4"><label>Bairro</label><input class="form-control" name="district" /></div>
            <div class="form-group col-md-5"><label>Cidade</label><input class="form-control" name="city" /></div>
            <div class="form-group col-md-3"><label>UF</label><input class="form-control" name="uf" maxlength="2" /></div>
          </div>

          <div class="form-group">
            <label>Observações</label>
            <input class="form-control" name="notes" placeholder="Alergias, preferências..." />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-pill" data-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary btn-pill" type="submit">Salvar paciente</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- libs -->
<script src="../js/jquery-3.4.1.min.js"></script>
<script src="../js/bootstrap.js"></script>

<!-- Configure o prefixo do n8n ANTES do crm-api.js (SEM barra final) -->
<script>
  window.CRM_API_BASE = 'https://allnsnts.app.n8n.cloud/webhook/odonto';
  // opcional: window.CRM_API_KEY = 'sua-chave-se-usar';
</script>

<!-- Funções de API (versão UMD que te enviei) -->
<script src="js/crm-api.js"></script>

<script>
  // Helpers de renderização
  function row(p) {
    const name = p.full_name || p.name || '—';
    const phone = p.phone || '—';
    const email = p.email || '—';
    const last = p.last_visit_date ? new Date(p.last_visit_date).toLocaleDateString('pt-BR') : '—';
    return `
      <tr>
        <td>${name}</td>
        <td>${phone}</td>
        <td>${email}</td>
        <td>${last}</td>
        <td class="text-right">
          <a class="btn btn-sm btn-outline-secondary btn-pill" href="prontuario.html?id=${p.id||''}">Prontuário</a>
          <a class="btn btn-sm btn-primary btn-pill" href="agenda.html?paciente=${encodeURIComponent(name)}">Agendar</a>
        </td>
      </tr>`;
  }

  let page=0, pageSize=20, currentQuery='';
  let lastBatch = [];

  async function loadList({q='', reset=false}={}){
    try{
      if(reset){ page=0; currentQuery=q; }
      const tbody = document.getElementById('pac-tbody');
      tbody.innerHTML = `<tr><td colspan="5" class="empty-hint">Carregando…</td></tr>`;

      // se houver busca, usa /patients/search?q=; se não, lista padrão /patients?limit=
      let results = [];
      if((currentQuery||'').trim().length>=2){
        results = await fetch(`${window.CRM_API_BASE}/patients/search?q=${encodeURIComponent(currentQuery)}`, { headers:{'Accept':'application/json'} }).then(r=>r.json());
      }else{
        results = await fetch(`${window.CRM_API_BASE}/patients?limit=50`, { headers:{'Accept':'application/json'} }).then(r=>r.json());
      }

      // paginação client-side simples
      lastBatch = Array.isArray(results)? results : [];
      const start = page*pageSize;
      const pageItems = lastBatch.slice(start, start+pageSize);

      if(pageItems.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="empty-hint">Nenhum paciente encontrado.</td></tr>`;
      }else{
        tbody.innerHTML = pageItems.map(row).join('');
      }

      // UI stats / buttons
      document.getElementById('pac-count').textContent = lastBatch.length;
      document.getElementById('p-prev').disabled = (page===0);
      document.getElementById('p-next').disabled = (start+pageSize>=lastBatch.length);

    }catch(err){
      console.error(err);
      document.getElementById('pac-tbody').innerHTML = `<tr><td colspan="5" class="empty-hint text-danger">${err.message||'Erro ao carregar'}</td></tr>`;
    }
  }

  // Eventos da lista
  document.getElementById('btn-buscar').addEventListener('click', ()=> loadList({q:document.getElementById('pac-busca').value, reset:true}));
  document.getElementById('pac-busca').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadList({q:e.target.value, reset:true}); });
  document.getElementById('p-prev').addEventListener('click', ()=>{ page=Math.max(0,page-1); loadList(); });
  document.getElementById('p-next').addEventListener('click', ()=>{ page=page+1; loadList(); });

  // Novo paciente (abre modal)
  document.getElementById('btn-novo').addEventListener('click', ()=> $('#md-paciente').modal('show'));

  // CEP → endereço e submit do paciente
  document.addEventListener('DOMContentLoaded', ()=>{
    // attachCepAutofill e upsertPaciente vêm do crm-api.js
    attachCepAutofill(document.getElementById('form-paciente'));

    document.getElementById('form-paciente').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f=e.target;
      const payload={
        org_id: document.getElementById('org-id').value,
        full_name: f.name.value.trim(),
        cpf:  f.cpf.value.trim() || null,
        dob:  f.dob.value || null,
        sex:  f.gender.value || null,
        phone:f.phone.value || null,
        email:f.email.value || null,
        address:{
          cep: f.cep.value || null, street:f.street.value || null, number:f.number.value || null,
          district:f.district.value || null, city:f.city.value || null, uf:f.uf.value || null
        },
        notes: f.notes.value || null
      };
      try{
        await upsertPaciente(payload);
        $('#md-paciente').modal('hide');
        // recarrega a lista atual
        await loadList({ q: currentQuery, reset:true });
      }catch(err){
        alert(err.message || 'Erro ao salvar paciente');
        console.error(err);
      }
    });

    // carrega a lista inicial
    loadList({reset:true});
  });
</script>
<!-- Action Sheet: Atalhos do botão "Lista" -->
<div id="crm-menu-sheet" class="crm-action-sheet">
  <div class="sheet-header">Ir para</div>
  <a class="sheet-item" href="inicio.html"><i class="fa-solid fa-house"></i> Início</a>
  <a class="sheet-item" href="agenda.html"><i class="fa-regular fa-calendar-days"></i> Agenda</a>
  <a class="sheet-item" href="pacientes.html"><i class="fa-regular fa-user"></i> Pacientes</a>
  <a class="sheet-item" href="orcamentos.html"><i class="fa-regular fa-folder-open"></i> Orçamentos</a>
  <a class="sheet-item" href="procedimentos.html"><i class="fa-solid fa-tooth"></i> Procedimentos</a>
  <a class="sheet-item" href="procedimentos.html"><i class="fa-solid fa-notes-medical"></i> Documentos</a>
  <a class="sheet-item" href="configuracoes.html"><i class="fa-solid fa-gear"></i> Configurações</a>
</div>
<!-- BOTTOM BAR • DRIBBBLE-LIKE -->
<nav class="bb-dribbble" id="bbBar" aria-label="Navegação rápida">
  <!-- fundo com onda + notch -->
  <svg class="bb-bg" viewBox="0 0 1000 160" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <filter id="bbShadow" x="-20%" y="-50%" width="140%" height="200%">
        <feDropShadow dx="0" dy="14" stdDeviation="12" flood-color="rgba(15,23,42,.10)"/>
        <feDropShadow dx="0" dy="4"  stdDeviation="6"  flood-color="rgba(15,23,42,.08)"/>
      </filter>
    </defs>

    <!-- Path com notch (estado “em repouso”) -->
    <path id="bbPath" class="bb-path" filter="url(#bbShadow)"
      d="M18,26
         H360
         C420,26 440,6 500,6
         C560,6 580,26 640,26
         H982 Q994,26 994,38 V140
         Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z" />

    <!-- Morph da onda ao tocar -->
    <animate id="bbMorph" xlink:href="#bbPath" attributeName="d" dur="420ms" fill="freeze"
      values="
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H330 C400,26 440,-18 500,-18 C560,-18 600,26 670,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z;
        M18,26 H360 C420,26 440,6 500,6 C560,6 580,26 640,26 H982 Q994,26 994,38 V140 Q994,152 982,152 H18 Q6,152 6,140 V38 Q6,26 18,26 Z
      " />
  </svg>

  <!-- Slots (mesma “placa”, sem borda) -->
  <button class="bb-tab" data-act="agenda" aria-label="Agenda">
    <i class="fa-regular fa-calendar-days"></i>
    <span>Agenda</span>
  </button>

  <button class="bb-fab" data-act="quick" aria-label="Ações rápidas">
    <i class="fa-solid fa-plus"></i>
  </button>

  <button class="bb-tab" data-act="menu" aria-label="Menu">
    <i class="fa-solid fa-list-ul"></i>
    <span>Menu</span>
  </button>
</nav>


<script>
(function () {
  const bar     = document.getElementById('crm-bottombar');
  const overlay = document.getElementById('crm-sheet-overlay');
  const quick   = document.getElementById('crm-quick-sheet');
  const menu    = document.getElementById('crm-menu-sheet');

  if (!bar) return;

  const openSheet = sheet => {
    closeSheets();
    overlay.classList.add('show');
    sheet.classList.add('show');
  };
  const closeSheets = () => {
    overlay.classList.remove('show');
    quick.classList.remove('show');
    menu.classList.remove('show');
  };

  // Navegação dos botões principais
  bar.addEventListener('click', (e) => {
    const act = e.target.closest('button')?.dataset?.act;
    if (!act) return;

    if (act === 'agenda') {
      window.location.href = 'agenda.html';
    } else if (act === 'menu') {
      openSheet(menu);
    } else if (act === 'quick') {
      openSheet(quick);
    }
  });

  // Fecha overlay
  overlay.addEventListener('click', closeSheets);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSheets(); });

  // Ações rápidas (+)
  quick.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-quick]');
    if(!btn) return;
    const what = btn.dataset.quick;

    const openModal = (id, fallbackUrl) => {
      if (window.$ && $(id).length) { $(id).modal('show'); }
      else window.location.href = fallbackUrl;
    };

    if (what === 'agendamento') {
      openModal('#md-agendamento','inicio.html'); // ou agenda.html, se preferir
    }
    if (what === 'paciente') {
      openModal('#md-paciente','inicio.html');
    }
    if (what === 'orcamento') {
      openModal('#md-orcamento','orcamentos.html');
    }
    if (what === 'procedimentos') {
      window.location.href = 'procedimentos.html';
    }
    closeSheets();
  });
})();
</script>

<script>
(function(){
  const API_BASE = (window.CRM_API_BASE || '').replace(/\/+$/,'');
  const UL = document.getElementById('upcoming-list');

  const qs = o => {
    const p = new URLSearchParams();
    Object.entries(o||{}).forEach(([k,v])=>{
      if(v!==undefined && v!==null && v!=='') p.append(k, String(v));
    });
    return p.toString() ? '?' + p.toString() : '';
  };

  function labelData(startISO, allDay){
    const d  = new Date(startISO);
    const n  = new Date();
    const d0 = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const n0 = new Date(n.getFullYear(), n.getMonth(), n.getDate());
    const diffDays = Math.round((d0 - n0)/86400000);

    const hhmm = allDay ? '' : ' ' + d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    if (diffDays === 0) return 'Hoje'    + hhmm;
    if (diffDays === 1) return 'Amanhã'  + hhmm;
    return d.toLocaleDateString('pt-BR', { weekday:'short' }) + hhmm; // ex: seg., ter., qua...
  }

  function render(items){
    UL.innerHTML = '';
    if(!items || !items.length){
      UL.innerHTML = '<li class="py-2 text-muted">Sem próximos agendamentos</li>';
      return;
    }
    items.forEach(ev=>{
      const when = labelData(ev.start, ev.allDay);
      const li = document.createElement('li');
      li.className = 'py-2 border-bottom';
      li.innerHTML = `
        <i class="fa-regular fa-clock mr-2" style="color:#10b981"></i>
        <strong>${when}</strong> – ${ev.title || '(sem título)'}
      `;
      UL.appendChild(li);
    });
  }

  async function loadUpcoming(){
    try{
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const url = API_BASE + '/calendar/upcoming' + qs({ days: 7, limit: 3, tz });
      const data = await CRMApi.getCalendarUpcoming({days:7, limit:3});
      const data = await res.json();
      const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
      render(items);
    }catch(err){
      console.error(err);
      UL.innerHTML = '<li class="py-2 text-danger">Erro ao carregar agenda</li>';
    }
  }

  loadUpcoming();
})();
</script>

<script>
(function(){
  const bar = document.getElementById('bbBar');
  if(!bar) return;

  const tabAgenda = bar.querySelector('.bb-tab[data-act="agenda"]');
  const tabMenu   = bar.querySelector('.bb-tab[data-act="menu"]');
  const fab       = bar.querySelector('.bb-fab');
  const morph     = document.getElementById('bbMorph');

  // seus sheets existentes
  const overlay = document.getElementById('crm-sheet-overlay');
  const quick   = document.getElementById('crm-quick-sheet');
  const menu    = document.getElementById('crm-menu-sheet');
  const openSheet = el => { overlay?.classList.add('show'); el?.classList.add('show'); };
  const closeSheets = () => { overlay?.classList.remove('show'); quick?.classList.remove('show'); menu?.classList.remove('show'); };
  overlay?.addEventListener('click', closeSheets);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSheets(); });

  function wave(){ try{ morph.beginElement(); }catch(e){} }
  function bounce(el){
    const i = el.querySelector('i'), s=el.querySelector('span');
    i?.classList.remove('bb-bounce'); s?.classList.remove('bb-bounce');
    void i?.offsetWidth; void s?.offsetWidth; // reflow
    i?.classList.add('bb-bounce'); s?.classList.add('bb-bounce');
  }
  function setActive(btn){
    [tabAgenda, tabMenu].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }

  tabAgenda.addEventListener('click', ()=>{
    setActive(tabAgenda); wave(); bounce(tabAgenda);
    setTimeout(()=> location.href='agenda.html', 120);
  });

  tabMenu.addEventListener('click', ()=>{
    setActive(tabMenu); wave(); bounce(tabMenu);
    openSheet(menu);
  });

  fab.addEventListener('click', ()=>{
    wave(); fab.classList.remove('bb-fab-pop'); void fab.offsetWidth; fab.classList.add('bb-fab-pop');
    openSheet(quick);
  });

  // estado inicial
  setActive(tabAgenda);
})();
</script>

</body>
</html>















